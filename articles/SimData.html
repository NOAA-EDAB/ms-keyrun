<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generating Simulated Data • mskeyrun</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Generating Simulated Data">
<meta property="og:description" content="mskeyrun">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mskeyrun</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/mskeyrun.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CompsDat.html">MS Keyrun Age, Length, and Diet Composition Data Needs</a>
    </li>
    <li>
      <a href="../articles/DataNeeds.html">MS Keyrun Data Needs</a>
    </li>
    <li>
      <a href="../articles/DatasetDimensions.html">MS Keyrun Dataset Dimensions</a>
    </li>
    <li>
      <a href="../articles/GBFleetDecisions.html">Fleet Definitions for Georges Bank</a>
    </li>
    <li>
      <a href="../articles/GBFleetDefinitions.html">Fleet Definitions for Georges Bank</a>
    </li>
    <li>
      <a href="../articles/GBLandingsByLength.html">Landings by Length for Georges Bank</a>
    </li>
    <li>
      <a href="../articles/SimData.html">Generating Simulated Data</a>
    </li>
    <li>
      <a href="../articles/SpeciesEnvDat.html">MS Keyrun Species, Environment, Data Formats</a>
    </li>
    <li>
      <a href="../articles/allocateLandingsEPU.html">Allocate landings to Georges Bank EPU</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/NOAA-EDAB/ms-keyrun/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="SimData_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Generating Simulated Data</h1>
                        <h4 class="author">Sarah Gaichas</h4>
            
            <h4 class="date">07 October, 2021</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NOAA-EDAB/ms-keyrun/blob/master/vignettes/SimData.Rmd"><code>vignettes/SimData.Rmd</code></a></small>
      <div class="hidden name"><code>SimData.Rmd</code></div>

    </div>

    
    
<div id="simulating-input-data-from-an-ecosystem-model" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-input-data-from-an-ecosystem-model" class="anchor"></a>Simulating input data from an ecosystem model</h2>
<p>Here we use existing <a href="https://github.com/Atlantis-Ecosystem-Model/Atlantis_example_and_instructions">Atlantis</a> ecosystem model output to generate input datasets for a variety of simpler population models, so that the performance of these models can be evaluated against known (simulated) ecosystem dynamics. Atlantis models simulate a wide range of physical and ecological processes, include a full food web, and can be run using different climate forcing, fishing, and other scenarios.</p>
<p>We extract simulated data using the R package <a href="https://github.com/r4atlantis/atlantisom">atlantisom</a>. The purpose of atlantisom is to use existing Atlantis model output to generate input datasets for a variety of models, so that the performance of these models can be evaluated against known (simulated) ecosystem dynamics. Atlantis models can be run using different climate forcing, fishing, and other scenarios. Users of atlantisom will be able to specify fishery independent and fishery dependent sampling in space and time, as well as species-specific catchability, selectivty, and other observation processes for any Atlantis scenario. Internally consistent multispecies and ecosystem datasets with known observation error characteristics will be the atlantisom outputs, for use in individual model performance testing, comparing performance of alternative models, and performance testing of model ensembles against “true” Atlantis outputs.</p>
</div>
<div id="species-in-the-ms-keyrun-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#species-in-the-ms-keyrun-dataset" class="anchor"></a>Species in the ms-keyrun dataset</h2>
<p>Our initial species selection includes 11 single species groups from the Atlantis NOBA model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#fgs &lt;- load_fgs(here("simulated-data/atlantisoutput/NOBA_March_2020"), "nordic_groups_v04.csv")</span>

<span class="va">lname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Name<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Long_rough_dab"</span>,
                                 <span class="st">"Green_halibut"</span>,
                                 <span class="st">"Mackerel"</span>,
                                 <span class="st">"Haddock"</span>,
                                 <span class="st">"Saithe"</span>,
                                 <span class="st">"Redfish"</span>,
                                 <span class="st">"Blue_whiting"</span>,
                                 <span class="st">"Norwegian_ssh"</span>,
                                 <span class="st">"North_atl_cod"</span>,
                                 <span class="st">"Polar_cod"</span>,
                                 <span class="st">"Capelin"</span><span class="op">)</span>,
                    Long.Name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Long rogh dab"</span>,
                                 <span class="st">"Greenland halibut"</span>,
                                 <span class="st">"Mackerel"</span>,
                                 <span class="st">"Haddock"</span>,
                                 <span class="st">"Saithe"</span>,
                                 <span class="st">"Redfish"</span>,
                                 <span class="st">"Blue whiting"</span>,
                                 <span class="st">"Norwegian spring spawning herring"</span>,
                                 <span class="st">"Northeast Atlantic Cod"</span>,
                                 <span class="st">"Polar cod"</span>,
                                 <span class="st">"Capelin"</span><span class="op">)</span>,
                    Latin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*Hippoglossoides platessoides*"</span>,
                              <span class="st">"*Reinhardtius hippoglossoides*"</span>,
                              <span class="st">"*Scomber scombrus*"</span>,
                              <span class="st">"*Melongrammus aeglefinus*"</span>,
                              <span class="st">"*Pollachius virens*"</span>,
                              <span class="st">"*Sebastes mentella*"</span>,
                              <span class="st">"*Micromesistius poutassou*"</span>,
                              <span class="st">"*Clupea harengus*"</span>,
                              <span class="st">"*Gadus morhua*"</span>,
                              <span class="st">"*Boreogadus saida*"</span>,
                              <span class="st">"*Mallotus villosus*"</span><span class="op">)</span>,
                    Code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LRD"</span>, <span class="st">"GRH"</span>, <span class="st">"MAC"</span>, <span class="st">"HAD"</span>, <span class="st">"SAI"</span>, <span class="st">"RED"</span>, 
                             <span class="st">"BWH"</span>, <span class="st">"SSH"</span>, <span class="st">"NCO"</span>, <span class="st">"PCO"</span>, <span class="st">"CAP"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># sppsubset &lt;- merge(fgs, lname, all.y = TRUE)</span>
<span class="co"># spptable &lt;- sppsubset %&gt;% </span>
<span class="co">#   arrange(Index) %&gt;%</span>
<span class="co">#   select(Name, Long.Name, Latin)</span>

<span class="va">spptable</span> <span class="op">&lt;-</span> <span class="va">lname</span> <span class="op">%&gt;%</span>
   <span class="fu">select</span><span class="op">(</span><span class="va">Name</span>, <span class="va">Long.Name</span>, <span class="va">Latin</span><span class="op">)</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span><span class="va">spptable</span>, col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Model name"</span>, <span class="st">"Full name"</span>, <span class="st">"Latin name"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Model name</th>
<th align="left">Full name</th>
<th align="left">Latin name</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Long_rough_dab</td>
<td align="left">Long rogh dab</td>
<td align="left"><em>Hippoglossoides platessoides</em></td>
</tr>
<tr class="even">
<td align="left">Green_halibut</td>
<td align="left">Greenland halibut</td>
<td align="left"><em>Reinhardtius hippoglossoides</em></td>
</tr>
<tr class="odd">
<td align="left">Mackerel</td>
<td align="left">Mackerel</td>
<td align="left"><em>Scomber scombrus</em></td>
</tr>
<tr class="even">
<td align="left">Haddock</td>
<td align="left">Haddock</td>
<td align="left"><em>Melongrammus aeglefinus</em></td>
</tr>
<tr class="odd">
<td align="left">Saithe</td>
<td align="left">Saithe</td>
<td align="left"><em>Pollachius virens</em></td>
</tr>
<tr class="even">
<td align="left">Redfish</td>
<td align="left">Redfish</td>
<td align="left"><em>Sebastes mentella</em></td>
</tr>
<tr class="odd">
<td align="left">Blue_whiting</td>
<td align="left">Blue whiting</td>
<td align="left"><em>Micromesistius poutassou</em></td>
</tr>
<tr class="even">
<td align="left">Norwegian_ssh</td>
<td align="left">Norwegian spring spawning herring</td>
<td align="left"><em>Clupea harengus</em></td>
</tr>
<tr class="odd">
<td align="left">North_atl_cod</td>
<td align="left">Northeast Atlantic Cod</td>
<td align="left"><em>Gadus morhua</em></td>
</tr>
<tr class="even">
<td align="left">Polar_cod</td>
<td align="left">Polar cod</td>
<td align="left"><em>Boreogadus saida</em></td>
</tr>
<tr class="odd">
<td align="left">Capelin</td>
<td align="left">Capelin</td>
<td align="left"><em>Mallotus villosus</em></td>
</tr>
</tbody>
</table>
<p>Below we will double check survey census outputs against the true values, and then test some survey specifications that may be reasonable for multispecies model testing. Finally we will apply survey functions to the detailed diet data.</p>
</div>
<div id="generating-a-census-dataset-february-2021" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-a-census-dataset-february-2021" class="anchor"></a>Generating a census dataset (February 2021)</h2>
<div id="configuration-files-specified-once" class="section level3">
<h3 class="hasAnchor">
<a href="#configuration-files-specified-once" class="anchor"></a>Configuration files specified once</h3>
<p><code>NOBA2config.R</code> specifies location and names of files needed for atlantisom to initialize:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d.name</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/atlantisoutput"</span>,<span class="st">"NOBA_march_2020"</span><span class="op">)</span>
<span class="va">functional.groups.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_groups_v04.csv"</span>
<span class="va">biomass.pools.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_biol_v23.nc"</span>
<span class="va">biol.prm.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_biol_incl_harv_v_007_3.prm"</span>
<span class="va">box.file</span> <span class="op">&lt;-</span> <span class="st">"Nordic02.bgm"</span>
<span class="va">initial.conditions.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_biol_v23.nc"</span>
<span class="va">run.prm.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_run_v01.xml"</span>
<span class="va">scenario.name</span> <span class="op">&lt;-</span> <span class="st">"nordic_runresults_01"</span>
<span class="va">bioind.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_runresults_01BiomIndx.txt"</span>
<span class="va">catch.file</span> <span class="op">&lt;-</span> <span class="st">"nordic_runresults_01Catch.txt"</span>
<span class="va">annage</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="va">fisheries.file</span> <span class="op">&lt;-</span> <span class="st">"NoBAFisheries.csv"</span></code></pre></div>
<p><code>omdimensions.R</code> standardizes timesteps, etc. (this is part of atlantisom and should not need to be changed by the user):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#survey species inherited from omlist_ss</span>
<span class="va">survspp</span> <span class="op">&lt;-</span> <span class="va">omlist_ss</span><span class="op">$</span><span class="va">species_ss</span>
<span class="co"># survey season and other time dimensioning parameters</span>
<span class="co"># generalized timesteps all models</span>
<span class="va">noutsteps</span> <span class="op">&lt;-</span> <span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">tstop</span><span class="op">/</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstep</span>
<span class="va">timeall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">noutsteps</span><span class="op">)</span>
<span class="va">stepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutinc</span>
<span class="va">midptyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># model areas, subset in surveyconfig</span>
<span class="va">allboxes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">boxpars</span><span class="op">$</span><span class="va">nbox</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co"># fishery output: learned the hard way this can be different from ecosystem outputs</span>
<span class="va">fstepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutfinc</span>

<span class="co"># survey selectivity (agecl based)</span>
<span class="va">sp_age</span> <span class="op">&lt;-</span> <span class="va">omlist_ss</span><span class="op">$</span><span class="va">funct.group_ss</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"NumCohorts"</span>, <span class="st">"NumAgeClassSize"</span><span class="op">)</span><span class="op">]</span>

<span class="co"># should return all age classes fully sampled (Atlantis output is 10 age groups per spp)</span>
<span class="va">n_age_classes</span> <span class="op">&lt;-</span> <span class="va">sp_age</span><span class="op">$</span><span class="va">NumCohorts</span>
<span class="co"># changed below for multiple species NOTE survspp alphabetical; NOT in order of fgs!!</span>
<span class="co"># this gives correct names</span>
<span class="va">age_classes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_age_classes</span>, <span class="va">seq</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">age_classes</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">sp_age</span><span class="op">$</span><span class="va">Name</span>

<span class="va">n_annages</span> <span class="op">&lt;-</span> <span class="va">sp_age</span><span class="op">$</span><span class="va">NumCohorts</span> <span class="op">*</span> <span class="va">sp_age</span><span class="op">$</span><span class="va">NumAgeClassSize</span>
<span class="co"># changed below for multiple species</span>
<span class="va">annages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_annages</span>, <span class="va">seq</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annages</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">sp_age</span><span class="op">$</span><span class="va">Name</span></code></pre></div>
</div>
<div id="change-these-survey-and-fishery-config-files" class="section level3">
<h3 class="hasAnchor">
<a href="#change-these-survey-and-fishery-config-files" class="anchor"></a>Change these survey and fishery config files</h3>
<p><code>mssurvey_spring.R</code> and <code>mssurvey_fall.R</code> configure the fishery independent surveys (in this census test, surveys sample all model polygons in all years and have efficiency of 1 for all species, with no size selectivity):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Default survey configuration here has a range of efficiencies and selectivities</span>
<span class="co"># To emulate a range of species in a single multispecies survey</span>
<span class="co"># Also now happens in "spring" and "fall"</span>
<span class="co"># Need to define survey season, area, efficiency, selectivity</span>

<span class="co"># Survey name</span>
<span class="va">survey.name</span><span class="op">=</span><span class="st">"BTS_spring_allbox_effic1"</span>

<span class="co">#Atlantis model timestep corresponding to the true output--now from census_spec.R</span>
<span class="va">timestep</span> <span class="op">&lt;-</span> <span class="va">stepperyr</span> <span class="co">#5</span>

<span class="co">#Which atlantis timestep does the survey run in?--now from census_spec.R</span>
<span class="co"># with 5 output steps per year, 0 is Jan-Feb-midMar, 1 is midMar-Apr-May, </span>
<span class="co"># 2 is June-July-midAug, 3 is midAug-Sept-Oct, 4 is Nov-Dec (ish)</span>

<span class="va">survey_sample_time</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="co"># spring survey</span>

<span class="co">#The last timestep to sample</span>
<span class="va">total_sample</span> <span class="op">&lt;-</span> <span class="va">noutsteps</span><span class="op">-</span><span class="fl">1</span> <span class="co">#495</span>

<span class="co">#Vector of indices of survey times to pull</span>
<span class="va">survey_sample_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">survey_sample_time</span>,
                          <span class="va">total_sample</span>, by<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>

<span class="va">survtime</span> <span class="op">&lt;-</span> <span class="va">survey_sample_full</span>

<span class="co"># survey area</span>
<span class="co"># should return all model areas</span>
<span class="va">survboxes</span> <span class="op">&lt;-</span> <span class="va">allboxes</span>

<span class="co"># survey efficiency (q)</span>
<span class="co"># should return a perfectly efficient survey </span>
<span class="va">surveffic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>,
                     efficiency<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># survey selectivity (agecl based)</span>
<span class="co"># this is by age class, need to change to use with ANNAGEBIO output</span>
<span class="co">#survselex &lt;- data.frame(species=rep(names(age_classes), each=n_age_classes),</span>
<span class="co">#                     agecl=rep(c(1:n_age_classes),length(survspp)),</span>
<span class="co">#                     selex=rep(1.0,length(survspp)*n_age_classes))</span>

<span class="co"># for annage output uses names(annages) NOT alphabetical survspp</span>
<span class="va">survselex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annages</span><span class="op">)</span>, <span class="va">n_annages</span><span class="op">)</span>, <span class="co">#  </span>
                        agecl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_annages</span>,<span class="va">seq</span><span class="op">)</span><span class="op">)</span>,
                        selex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.0</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_annages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">survselex.agecl</span> <span class="op">&lt;-</span> <span class="va">survselex</span>


<span class="co"># effective sample size needed for sample_fish</span>
<span class="co"># this effective N is high but not equal to total for numerous groups</span>
<span class="va">surveffN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, effN<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># survey index cv needed for sample_survey_xxx</span>
<span class="co"># cv = 0.1</span>
<span class="va">surv_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, cv<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># length at age cv for input into calc_age2length function</span>
<span class="co"># function designed to take one cv for all species, need to change to pass it a vector</span>
<span class="va">lenage_cv</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>

<span class="co"># max size bin for length estimation, function defaults to 150 cm if not supplied</span>
<span class="va">maxbin</span> <span class="op">&lt;-</span> <span class="fl">200</span>

<span class="co"># diet sampling parameters</span>
<span class="va">alphamult</span> <span class="op">&lt;-</span> <span class="fl">10000000</span>
<span class="va">unidprey</span> <span class="op">&lt;-</span> <span class="fl">0</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Default survey configuration here has a range of efficiencies and selectivities</span>
<span class="co"># To emulate a range of species in a single multispecies survey</span>
<span class="co"># Also now happens in "spring" and "fall"</span>
<span class="co"># Need to define survey season, area, efficiency, selectivity</span>

<span class="co"># Survey name</span>
<span class="va">survey.name</span><span class="op">=</span><span class="st">"BTS_fall_allbox_effic1"</span>

<span class="co">#Atlantis model timestep corresponding to the true output--now from census_spec.R</span>
<span class="va">timestep</span> <span class="op">&lt;-</span> <span class="va">stepperyr</span> <span class="co">#5</span>

<span class="co">#Which atlantis timestep does the survey run in?--now from census_spec.R</span>
<span class="co"># with 5 output steps per year, 0 is Jan-Feb-midMar, 1 is midMar-Apr-May, </span>
<span class="co"># 2 is June-July-midAug, 3 is midAug-Sept-Oct, 4 is Nov-Dec (ish)</span>

<span class="va">survey_sample_time</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="co"># fall survey</span>

<span class="co">#The last timestep to sample</span>
<span class="va">total_sample</span> <span class="op">&lt;-</span> <span class="va">noutsteps</span><span class="op">-</span><span class="fl">1</span> <span class="co">#495</span>

<span class="co">#Vector of indices of survey times to pull</span>
<span class="va">survey_sample_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">survey_sample_time</span>,
                          <span class="va">total_sample</span>, by<span class="op">=</span><span class="va">timestep</span><span class="op">)</span>

<span class="va">survtime</span> <span class="op">&lt;-</span> <span class="va">survey_sample_full</span>

<span class="co"># survey area</span>
<span class="co"># should return all model areas</span>
<span class="va">survboxes</span> <span class="op">&lt;-</span> <span class="va">allboxes</span>

<span class="co"># survey efficiency (q)</span>
<span class="co"># should return a perfectly efficient survey </span>
<span class="va">surveffic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>,
                     efficiency<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># survey selectivity (agecl based)</span>
<span class="co"># this is by age class, need to change to use with ANNAGEBIO output</span>
<span class="co">#survselex &lt;- data.frame(species=rep(survspp, each=n_age_classes),</span>
<span class="co">#                     agecl=rep(c(1:n_age_classes),length(survspp)),</span>
<span class="co">#                     selex=rep(1.0,length(survspp)*n_age_classes))</span>

<span class="co"># for annage output</span>
<span class="va">survselex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">annages</span><span class="op">)</span>, <span class="va">n_annages</span><span class="op">)</span>, <span class="co">#  </span>
                        agecl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">n_annages</span>,<span class="va">seq</span><span class="op">)</span><span class="op">)</span>,
                        selex<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1.0</span>,<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n_annages</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">survselex.agecl</span> <span class="op">&lt;-</span> <span class="va">survselex</span> 


<span class="co"># effective sample size needed for sample_fish</span>
<span class="co"># this effective N is high but not equal to total for numerous groups</span>
<span class="va">surveffN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, effN<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># survey index cv needed for sample_survey_xxx</span>
<span class="co"># cv = 0.1</span>
<span class="va">surv_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, cv<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># length at age cv for input into calc_age2length function</span>
<span class="co"># function designed to take one cv for all species, need to change to pass it a vector</span>
<span class="va">lenage_cv</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>

<span class="co"># max size bin for length estimation, function defaults to 150 cm if not supplied</span>
<span class="va">maxbin</span> <span class="op">&lt;-</span> <span class="fl">200</span>

<span class="co"># diet sampling parameters</span>
<span class="va">alphamult</span> <span class="op">&lt;-</span> <span class="fl">10000000</span>
<span class="va">unidprey</span> <span class="op">&lt;-</span> <span class="fl">0</span></code></pre></div>
<p><code>msfishery.R</code> configures the fishery dependent data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Default fishery configuration here is a census</span>
<span class="va">fishery.name</span><span class="op">=</span><span class="st">"census"</span>

<span class="co"># Inherits species from input omlist_ss</span>
<span class="va">fishspp</span> <span class="op">&lt;-</span> <span class="va">omlist_ss</span><span class="op">$</span><span class="va">species_ss</span> 

<span class="co">#Number of years of data to pull</span>
<span class="va">nyears</span> <span class="op">&lt;-</span> <span class="fl">50</span>

<span class="co">#Atlantis initialization period in years</span>
<span class="va">burnin</span> <span class="op">&lt;-</span> <span class="fl">30</span>

<span class="co"># fishery output: learned the hard way this can be different from ecosystem outputs</span>
<span class="va">fstepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutfinc</span>


<span class="co"># same time dimensioning parameters as in surveycensus.R</span>
<span class="co">#Vector of indices of catch in numbers to pull (by timestep to sum)</span>
<span class="va">fish_sample_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">total_sample</span><span class="op">)</span>  <span class="co">#total_sample defined in sardinesurvey.R</span>
<span class="va">fish_burnin</span> <span class="op">&lt;-</span> <span class="va">burnin</span><span class="op">*</span><span class="va">fstepperyr</span><span class="op">+</span><span class="fl">1</span>
<span class="va">fish_nyears</span> <span class="op">&lt;-</span> <span class="va">nyears</span><span class="op">*</span><span class="va">fstepperyr</span>
<span class="va">fish_times</span> <span class="op">&lt;-</span> <span class="va">fish_sample_full</span><span class="op">[</span><span class="va">fish_burnin</span><span class="op">:</span><span class="op">(</span><span class="va">fish_burnin</span><span class="op">+</span><span class="va">fish_nyears</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span>
<span class="va">fish_timesteps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">fish_times</span><span class="op">[</span><span class="va">fstepperyr</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fish_times</span><span class="op">)</span>, by<span class="op">=</span><span class="va">fstepperyr</span><span class="op">)</span> <span class="co">#last timestep</span>
<span class="co">#fish_years &lt;- unique(floor(fish_times/fstepperyr)+1) # my original</span>
<span class="va">fish_years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">fish_times</span><span class="op">/</span><span class="va">fstepperyr</span><span class="op">)</span><span class="op">)</span> <span class="co">#from Christine's new sardine_config.R</span>

<span class="va">fishtime</span> <span class="op">&lt;-</span> <span class="va">fish_times</span>


<span class="co"># fishery sampling area</span>
<span class="co"># should return all model areas, this assumes you see everything that it caught</span>
<span class="va">fishboxes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">boxpars</span><span class="op">$</span><span class="va">nbox</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co"># effective sample size needed for sample_fish</span>
<span class="co"># this effective N is divided by the number of annual timesteps below, so 200 per time</span>
<span class="co"># use as input to the length samples, ages can be a subset</span>
<span class="va">fisheffN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, effN<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">#this adjusts for subannual fishery output so original effN is for whole year</span>
<span class="va">fisheffN</span><span class="op">$</span><span class="va">effN</span> <span class="op">&lt;-</span> <span class="va">fisheffN</span><span class="op">$</span><span class="va">effN</span><span class="op">/</span><span class="va">fstepperyr</span> 

<span class="co"># fishery catch cv can be used in sample_survey_biomass</span>
<span class="co"># perfect observation</span>
<span class="va">fish_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species<span class="op">=</span><span class="va">survspp</span>, cv<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">survspp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="run-atlantisom-and-save-outputs" class="section level3">
<h3 class="hasAnchor">
<a href="#run-atlantisom-and-save-outputs" class="anchor"></a>Run atlantisom and save outputs</h3>
<p>True datasets are generated as follows, using <code>atlantisom</code> wrapper functions <code>om_init</code> to assemble initial true atlantis data, <code>om_species</code> to subset true data for desired species, <code>om_index</code> to generate survey biomass and total catch biomass indices, <code>om_comps</code> to generate age and length compositions and average weight at age from surveys and fisheries, and <code>om_diet</code> to generate diet from surveys. Outputs are saved to the <code>atlantisoutput</code> folder (not kept on github due to size):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">NOBAom</span> <span class="op">&lt;-</span> <span class="fu">om_init</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/NOBA2Config.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">NOBAom_ms</span> <span class="op">&lt;-</span> <span class="fu">om_species</span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span>, <span class="va">NOBAom</span><span class="op">)</span>

<span class="co">#need to change internal call to source in atlantisom om_index om_comps and om_diet functions</span>
<span class="co">#expecting a config folder in same directory as rmd</span>
<span class="co">#this is a workaround</span>

<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"docs/config"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/omdimensions.R"</span><span class="op">)</span>, <span class="fu">here</span><span class="op">(</span><span class="st">"docs/config/omdimensions.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">NOBAom_ms_ind</span> <span class="op">&lt;-</span> <span class="fu">om_index</span><span class="op">(</span>usersurvey <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span>, 
                                         <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>, 
                           userfishery <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/msfishery.R"</span><span class="op">)</span>,
                           omlist_ss <span class="op">=</span> <span class="va">NOBAom_ms</span>, 
                           n_reps <span class="op">=</span> <span class="fl">1</span>, 
                           save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">NOBAom_ms_comp</span> <span class="op">&lt;-</span> <span class="fu">om_comps</span><span class="op">(</span>usersurvey <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span>, 
                                         <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>, 
                           userfishery <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/msfishery.R"</span><span class="op">)</span>,
                           omlist_ss <span class="op">=</span> <span class="va">NOBAom_ms</span>, 
                           n_reps <span class="op">=</span> <span class="fl">1</span>, 
                           save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">NOBAom_ms_diet</span> <span class="op">&lt;-</span> <span class="fu">om_diet</span><span class="op">(</span>config <span class="op">=</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config"</span>, <span class="st">"NOBA2config.R"</span><span class="op">)</span>,
                          dietfile <span class="op">=</span> <span class="st">"NOBADetDiet.gz"</span>,
                          usersurvey <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span>, 
                                         <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>, 
                          omlist_ss <span class="op">=</span> <span class="va">NOBAom_ms</span>, 
                          n_reps <span class="op">=</span> <span class="fl">1</span>, 
                          save <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"docs/config"</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="write-to-model-input-files" class="section level3">
<h3 class="hasAnchor">
<a href="#write-to-model-input-files" class="anchor"></a>Write to model input files</h3>
<div id="multispecies-surplus-production-model-msspm" class="section level4">
<h4 class="hasAnchor">
<a href="#multispecies-surplus-production-model-msspm" class="anchor"></a>Multispecies surplus production model (MSSPM)</h4>
<p>Example input files are in the <code>model-input-files</code> directory. First we write the fairly simple biomass and catch inputs for the multispecies surplus production model MSSPM from our census survey outputs.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">o.name</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/msinput/msspm/"</span><span class="op">)</span>

<span class="va">stepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutinc</span>

<span class="co">#read in survey biomass data</span>
<span class="va">survObsBiom</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survB'</span><span class="op">)</span> <span class="co">#reads in all surveys</span>

<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">svbio</span> <span class="op">&lt;-</span> <span class="va">survObsBiom</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="co">#calc_timestep2time(d.name, ., run.prm.file) %&gt;% #this gives an arbitrary start year of 1970</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#read in catch data</span>
<span class="va">read_savedfisheries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span>, <span class="va">type</span><span class="op">)</span><span class="op">{</span>

  <span class="va">datlook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>dattype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Catch'</span>, <span class="st">'catchAge'</span>, <span class="st">'catchLen'</span>, <span class="st">'catchWtage'</span>, <span class="st">'catchAnnAge'</span>, <span class="st">'catchAnnWtage'</span><span class="op">)</span>,
                        pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*fishCatch.rds"</span>, <span class="st">"*fishObsAgeComp.rds"</span>, <span class="st">"*fishObsLenComp.rds"</span>, <span class="st">"*fishObsWtAtAge.rds"</span>,
                                    <span class="st">"*fishObsFullAgeComp.rds"</span>, <span class="st">"*fishObsFullWtAtAge.rds"</span><span class="op">)</span><span class="op">)</span>

  <span class="va">fisheries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="va">dir</span>, pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">datlook</span><span class="op">$</span><span class="va">pattern</span><span class="op">[</span><span class="va">datlook</span><span class="op">$</span><span class="va">dattype</span> <span class="op">%in%</span> <span class="va">type</span><span class="op">]</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

  <span class="va">fishery.name</span> <span class="op">&lt;-</span>  <span class="fu">str_match</span><span class="op">(</span><span class="va">fisheries</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>,<span class="st">"_\\s*(.*?)\\s"</span>,<span class="va">datlook</span><span class="op">$</span><span class="va">pattern</span><span class="op">[</span><span class="va">datlook</span><span class="op">$</span><span class="va">dattype</span><span class="op">==</span><span class="va">type</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>

  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">fisheries</span>, <span class="va">readRDS</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">fishery.name</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">catchbio_ss</span> <span class="op">&lt;-</span> <span class="fu">read_savedfisheries</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'Catch'</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchbio_ss</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">catchbio</span> <span class="op">&lt;-</span> <span class="va">catchbio_ss</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">time</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"fishery_"</span>,<span class="va">c</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#write readme for metadata</span>
<span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Simulated data from Norweigan-Barents Atlantis Model by Hansen et al. \n\n"</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Atlantis outputs stored in"</span>, <span class="va">d.name</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Biomass output for surveys"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">)</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Fishery catch output for fisheries"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchbio_ss</span><span class="op">)</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="st">"Biomass and catch output units are annual tons.\n\n"</span>,
          <span class="st">"Survey specifications:\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_fall_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_spring_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n\n"</span>,
          <span class="st">"Fishery specifications:\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/msfishery.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/msfishery_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>
          <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/msinput/msspm/"</span><span class="op">)</span>,<span class="st">"README.txt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The MSSPM needs diet compostion information as well. Here we supply two survey time series of diet data, one census and a trial survey dataset with more typical survey coverage issues.</p>
<p>Diet composition is by predator age class for each time (unit=time.days) and is a proportion (sums to 1 for each time). We get species diet composition by aggregating over age classes (weight diet composition at age by true biomass at age).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/NOBA2Config.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">all_diets</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survDiet'</span><span class="op">)</span>

<span class="co"># divide time.days by runpar$toutinc to match time in biomass</span>
<span class="co"># aggregate over ages using true biomass at age (survey diet is in proportion by age)</span>

<span class="va">NOBAom_ms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>, <span class="st">"omlist_ss.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">trueB_age_allbox</span> <span class="op">&lt;-</span> <span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">truebio_ss</span> <span class="op">%&gt;%</span>
  <span class="co">#sum over polygons</span>
  <span class="co">#aggregate(dat$atoutput,list(dat$species,dat$agecl,dat$time, dat$prey),sum)</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>,<span class="va">agecl</span>,<span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>trueBatage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span>

<span class="va">trueB</span> <span class="op">&lt;-</span> <span class="va">trueB_age_allbox</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>trueB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">trueBatage</span><span class="op">)</span><span class="op">)</span>
  
<span class="va">trueBagecl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">trueB_age_allbox</span>, <span class="va">trueB</span><span class="op">)</span>

<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_diets</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">svdiet</span> <span class="op">&lt;-</span> <span class="va">all_diets</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="co">#calc_timestep2time(d.name, ., run.prm.file) %&gt;% #this gives an arbitrary start year of 1970</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time.days</span><span class="op">/</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutinc</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">trueBagecl</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dietBwt <span class="op">=</span> <span class="va">dietSamp</span><span class="op">*</span><span class="va">trueBatage</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>,<span class="va">time</span>,<span class="va">prey</span>,<span class="va">trueB</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>totdietBwt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dietBwt</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>totdietComp <span class="op">=</span> <span class="va">totdietBwt</span><span class="op">/</span><span class="va">trueB</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">species</span>, <span class="va">prey</span>, <span class="va">totdietComp</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"diet_"</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="length-structured-multispecies-model-hydra" class="section level4">
<h4 class="hasAnchor">
<a href="#length-structured-multispecies-model-hydra" class="anchor"></a>Length-structured multispecies model (Hydra)</h4>
<p>For the length-based model <a href="https://github.com/thefaylab/hydra_sim">hydra</a>, we can write .csv files to be used as input in the <a href="https://github.com/thefaylab/hydradata">hydradata</a> package, which writes .dat and .pin files.</p>
<p>Hydra needs survey biomass time series, catch time series, survey length composition, fishery length composition, and diet composition data.</p>
<p>Observations for biomass and catch are very similar to those created for MMSPM. Hydra inputs will need to be in the same species order for each dataset, so first we make a species file and some of the other input data that can come straight from Atlantis.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># foodweb and species file identify predators and prey; take from true atlantis diet comp</span>
<span class="va">diettrue</span> <span class="op">&lt;-</span> <span class="fu">load_diet_comp</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/atlantisoutput/NOBA_march_2020"</span><span class="op">)</span>, 
                           <span class="st">"nordic_runresults_01DietCheck.txt"</span>, fgs <span class="op">=</span> <span class="va">fgs</span><span class="op">)</span>
<span class="va">ms_diet</span> <span class="op">&lt;-</span> <span class="va">diettrue</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">%in%</span> <span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>,
         prey <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">prey</span><span class="op">)</span><span class="op">)</span>

<span class="va">predPrey</span> <span class="op">&lt;-</span> <span class="va">ms_diet</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">prey</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">time.days</span>, <span class="va">prey</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">prey</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>avgpreyprop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span>

<span class="va">foodweb</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">sppsubset</span>, <span class="va">predPrey</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span> <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="va">prey</span>, <span class="va">avgpreyprop</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>avgpreyprop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">avgpreyprop</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">spread</span><span class="op">(</span><span class="va">species</span>, <span class="va">avgpreyprop</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">prey</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/replace.html">replace</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>
  
<span class="va">predOrPrey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">foodweb</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>

<span class="va">specieslist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">species</span><span class="op">)</span><span class="op">)</span>,
                          guild <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"na"</span><span class="op">)</span>,
                          guildmember <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span>,
                          predOrPrey <span class="op">=</span> <span class="va">predOrPrey</span>
<span class="op">)</span>

<span class="co"># take lenwt parameters from true atlantis pars</span>
<span class="va">lenwtpar</span> <span class="op">&lt;-</span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">sppsubset</span>, <span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">biol</span><span class="op">$</span><span class="va">wl</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Code"</span> <span class="op">=</span> <span class="st">"group"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">Name</span>, <span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">Name</span><span class="op">)</span>

<span class="co"># fixed parameters:</span>
<span class="co"># intake same for all teleosts</span>
<span class="va">intakespp</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort.default</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span>,
                    alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.004</span><span class="op">)</span>,
                    beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.11</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">intakespp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">intakespp</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
<span class="va">intakespp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">intakespp</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>

<span class="co"># predator size preference ratio same for all species</span>
<span class="va">sizepref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort.default</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span>,
                  mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,
                  sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">sizepref</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sizepref</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>
<span class="va">sizepref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sizepref</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>

<span class="co"># dimensions for singletons file</span>
<span class="va">singletons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  debug<span class="op">=</span><span class="fl">3</span>,
  Nyrs<span class="op">=</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">nyears</span>, <span class="co">#may want to take from survey time series instead</span>
  Nspecies<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span>,
  Nsizebins<span class="op">=</span><span class="fl">5</span>,
  Nareas<span class="op">=</span><span class="fl">1</span>,
  Nfleets<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">truecatchage_ss</span><span class="op">$</span><span class="va">fleet</span><span class="op">)</span><span class="op">)</span>,
  Nsurveys<span class="op">=</span><span class="fl">2</span>,
  wtconv<span class="op">=</span><span class="fl">1</span>,
  yr1Nphase<span class="op">=</span><span class="fl">0</span>,
  recphase<span class="op">=</span><span class="fl">0</span>,
  avg_rec_phase<span class="op">=</span><span class="fl">0</span>,
  avg_F_phase<span class="op">=</span><span class="fl">0</span>,
  dev_rec_phase<span class="op">=</span><span class="fl">0</span>,
  dev_F_phase<span class="op">=</span><span class="fl">0</span>,
  fqphase<span class="op">=</span><span class="fl">0</span>,
  sqphase<span class="op">=</span><span class="fl">0</span>,
  ssig_phase<span class="op">=</span><span class="fl">0</span>,
  csig_phase<span class="op">=</span><span class="fl">0</span>,
  phimax<span class="op">=</span><span class="fl">1</span>,
  scaleInitialN<span class="op">=</span><span class="fl">1</span>,
  otherFood<span class="op">=</span><span class="fl">0000</span>,
  LFI_size<span class="op">=</span><span class="fl">60</span>,
  bandwidth_metric<span class="op">=</span><span class="fl">5</span>,
  assessmentPeriod<span class="op">=</span><span class="fl">3</span>,
  flagMSE<span class="op">=</span><span class="fl">0</span>,
  flagLinearRamp<span class="op">=</span><span class="fl">1</span>,
  baseline_threshold<span class="op">=</span><span class="fl">0.2</span>
<span class="op">)</span>

<span class="co"># M1 same for all species, depends on n length bins</span>
<span class="co"># to get annual M1 of 0.1, this matrix needs to be M1 per timestep</span>
<span class="co"># right now input works for 5 timesteps per year, but should be </span>
<span class="co"># done in the code with input annual M1 in case timestep changes</span>
<span class="va">M1mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nspecies</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nsizebins</span>, 
                dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort.default</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span>,  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sizeclass"</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">singletons</span><span class="op">$</span><span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 
<span class="va">M1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">M1mat</span><span class="op">)</span>

<span class="co"># sexratio fixed 50:50 for all species</span>
<span class="va">sexratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nspecies</span>,
                   dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"ratio"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort.default</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="co"># placeholders for unused covariates dimenstioned to the number of simulated years</span>
<span class="va">dummycovar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>dummy1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">nyears</span><span class="op">)</span><span class="op">)</span>

<span class="co"># placeholder for effort data dimensioned by year and nfleets</span>
<span class="va">allfleets</span> <span class="op">&lt;-</span> <span class="fu">atlantisom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/atlantisom/man/load_fisheries.html">load_fisheries</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="va">fisheries.file</span><span class="op">)</span>
<span class="va">fleets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">truecatchage_ss</span><span class="op">$</span><span class="va">fleet</span><span class="op">)</span>

<span class="va">dummyeffort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">singletons</span><span class="op">$</span><span class="va">Nyrs</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nyrs</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nfleets</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dummyeffort</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="va">fleets</span><span class="op">)</span>

<span class="co"># will need to fit von B and maturity curve functions to back out hydra input pars</span>
<span class="co"># maturity from maturity ogive input in biol file</span>
<span class="co"># growth functions from length at age in model...</span>

<span class="co"># write the csvs</span>
<span class="va">o.name</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/msinput/hydra/"</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">foodweb</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"foodweb_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">specieslist</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"speciesList_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">lenwtpar</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"lengthweight_species_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">intakespp</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"intake_species_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">sizepref</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"mortality_M2sizePreference_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">singletons</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"singletons_NOBA.csv"</span><span class="op">)</span>, sep<span class="op">=</span><span class="st">","</span>,  col.names<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">M1</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"mortality_M1_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">dummycovar</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"recruitment_covariates_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">dummycovar</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"maturity_covariates_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">dummycovar</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"growth_covariates_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">dummyeffort</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_effort_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">sexratio</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"sexratio_NOBA.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Decisions on size bins for hydra: keep 5 bins per species for now, build in flexibility to allocate size data to any number of bins with any definitions.</p>
<p>Species specific bin width definitions are an input into the model, with more refined (smaller) bin sizes during rapid growth phases.</p>
<p>Initially, we’ll directly transfer bin widths for GB and NOBA common species:</p>
<ul>
<li>Aherring = <a href="https://www.hi.no/en/hi/temasider/species/herring">Norwegian_ssh</a>
</li>
<li>Acod = <a href="https://www.hi.no/en/hi/temasider/species/cod--northeast-arctic">North_atl_cod</a> (<em>but max size could be bigger in simulated data, may need to increase last bin</em>)</li>
<li>haddock = <a href="https://www.hi.no/en/hi/temasider/species/haddock">Haddock</a> (<em>but max size could be bigger in simulated data, may need to increase last bin</em>)</li>
<li>Amackerel = <a href="https://www.hi.no/en/hi/temasider/species/mackerel">Mackerel</a>. (<em>note, should mackerel have smaller bin widths for fast early growth?</em>)</li>
</ul>
<p>We will substitute bin widths from these similar taxa/size GB species for NOBA:</p>
<ul>
<li>silverhake ~ <a href="https://www.hi.no/en/hi/temasider/species/blue-whiting">Blue_whiting</a><br>
</li>
<li>yellowtailfl ~ <a href="https://www.sciencedirect.com/science/article/abs/pii/S1385110196907972">Long_rough_dab</a> a.k.a. American plaice</li>
</ul>
<p>We will modify or subsitute bin widths for the rest of the NOBA species based on size:</p>
<ul>
<li>NOBA <a href="https://www.hi.no/en/hi/temasider/species/redfish/beaked-redfish-in-the-barents-and-norwegian-seas">Redfish</a> have a maximum size of 47 cm, use 5 x 10 cm bins<br>
</li>
<li>NOBA <a href="https://www.hi.no/en/hi/temasider/species/northeast-arctic-saithe">Saithe</a> have a maximum size of 130 cm; use goosefish bins</li>
<li>NOBA <a href="https://www.hi.no/en/hi/temasider/species/polar-cod">Polar_cod</a> have a maximum size of 25 cm; use 5 x 5 cm bins<br>
</li>
<li>NOBA <a href="https://www.hi.no/en/hi/temasider/species/capelin-in-the-barents-sea">Capelin</a> are smaller than any GB modeled species, max size 21 cm; use 5 x 5 cm bins<br>
</li>
<li>NOBA <a href="https://www.hi.no/en/hi/temasider/species/greenland-halibut">Green_halibut</a> are large, max size 120 cm; use Acod bins</li>
</ul>
<p>Code to make sizebins csv for input; hardcoded based on these decisions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for reference, GB hydra_sim size bins</span>
<span class="co"># sizeclass1,sizeclass2,sizeclass3,sizeclass4,sizeclass5,commentField-notused</span>
<span class="co"># 20,20,20,20,30,spinydog</span>
<span class="co"># 20,20,20,20,40,winterskate</span>
<span class="co"># 5,5,5,5,20,Aherring</span>
<span class="co"># 20,20,20,40,50,Acod</span>
<span class="co"># 10,10,20,20,20,haddock</span>
<span class="co"># 10,10,10,10,20,yellowtailfl</span>
<span class="co"># 10,10,10,10,10,winterfl</span>
<span class="co"># 10,10,10,10,10,Amackerel</span>
<span class="co"># 10,10,10,10,30,silverhake</span>
<span class="co"># 20,20,20,30,40,goosefish</span>

<span class="va">sizebinmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nspecies</span>, <span class="va">singletons</span><span class="op">$</span><span class="va">Nsizebins</span>, 
                dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort.default</a></span><span class="op">(</span><span class="va">sppsubset</span><span class="op">$</span><span class="va">Name</span><span class="op">)</span><span class="op">)</span>,  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sizeclass"</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">singletons</span><span class="op">$</span><span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Blue_whiting"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">30</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Capelin"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Green_halibut"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">40</span>,<span class="fl">50</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Haddock"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">20</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Long_rough_dab"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Mackerel"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"North_atl_cod"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">40</span>,<span class="fl">50</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Norwegian_ssh"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Polar_cod"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Redfish"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span>
<span class="va">sizebinmat</span><span class="op">[</span><span class="st">"Saithe"</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">20</span>,<span class="fl">30</span>,<span class="fl">40</span><span class="op">)</span>

<span class="va">sizebins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sizebinmat</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span><span class="st">'commentField-notused'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">sizebinmat</span><span class="op">)</span><span class="op">)</span>
                        
<span class="fu">write_csv</span><span class="op">(</span><span class="va">sizebins</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"length_sizebins_NOBA.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>These decisions on matching species can carry through to other life history parameters, at least initially.</p>
<p>Need to fit growth and maturity parameters from Atlantis output for input into hydra. Fit growth using code below, based on the package FSA <span class="citation">[@ogle-fsa-2021]</span>. The package provides multiple ways to get starting values for the R <code>nls</code> function for fitting nonlinear models. It was necessary to try several different methods for starting values to get at least one von Bertalannfy growth parameter set for each species. A scratch code block shows some of the experiments to get the fitting working that resulted in the function to fit for all surveys.</p>
<p>Note that spring surveys don’t get mackerel at all (not in the model domain then). A full set of von B parameters could only be estimated for the first era of both versions of the fall survey tested here.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp_age</span> <span class="op">&lt;-</span> <span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">funct.group_ss</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Name"</span>, <span class="st">"NumCohorts"</span>, <span class="st">"NumAgeClassSize"</span><span class="op">)</span><span class="op">]</span>
<span class="va">sp_age</span> <span class="op">&lt;-</span> <span class="va">sp_age</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>n_annages <span class="op">=</span> <span class="va">NumCohorts</span> <span class="op">*</span> <span class="va">NumAgeClassSize</span><span class="op">)</span> 

<span class="va">stepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutinc</span>


<span class="co"># need growth, vonB t0, K, and Linf and simple growth function</span>
<span class="co"># would you really base this on 140 years of data? I used all survey years </span>

<span class="va">len_comp_data</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survLen'</span><span class="op">)</span>

<span class="co"># need to shift agecl to represent midpoint of actual age groups</span>
<span class="co"># using part of the wtage interpolation function calc_avgwtstage2age()</span>
<span class="va">annage_comp_data</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survAnnAge'</span><span class="op">)</span>



<span class="va">vb1</span> <span class="op">&lt;-</span> <span class="fu">vbFuns</span><span class="op">(</span><span class="op">)</span>
<span class="co"># VBGF packages all take age and length pairs, reformat from length comp at agecl</span>
<span class="co"># break into 3 chunks of time, "era" 48 years each more like our survey</span>
<span class="co"># subsample after reformatting with uncount because we wouldn't have this many ages</span>

<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">len_comp_data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">annages</span> <span class="op">&lt;-</span> <span class="va">annage_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">time</span>, <span class="va">agecl</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span><span class="op">(</span>trueage <span class="op">=</span> <span class="va">agecl</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarise</span><span class="op">(</span>truenatage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span>
    
  <span class="co"># Figure out the groups that have multiple ages classes in each stage (or</span>
  <span class="co"># cohort)</span>
  <span class="va">multiple_ages</span> <span class="op">&lt;-</span> <span class="va">sp_age</span><span class="op">[</span><span class="va">sp_age</span><span class="op">$</span><span class="va">NumAgeClassSize</span><span class="op">&gt;</span><span class="fl">1</span>,<span class="op">]</span>
  
  <span class="co"># finds the average age of each agecl each timestep based on truenatage</span>
  <span class="va">svlen_avgage</span> <span class="op">&lt;-</span> <span class="va">annages</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">multiple_ages</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"species"</span> <span class="op">=</span> <span class="st">"Name"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>agecl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">trueage</span><span class="op">/</span><span class="va">NumAgeClassSize</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">time</span>, <span class="va">agecl</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>avgage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">trueage</span>, <span class="va">truenatage</span><span class="op">)</span><span class="op">)</span>


  <span class="co">#arrange into long format: year, Species, agecl, length </span>
  <span class="va">svlenage</span> <span class="op">&lt;-</span> <span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">svlen_avgage</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">avgage</span>, <span class="va">year</span>, <span class="va">upper.bins</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>avgage <span class="op">=</span> <span class="fu">coalesce</span><span class="op">(</span><span class="va">avgage</span>,<span class="va">agecl</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>length <span class="op">=</span> <span class="va">upper.bins</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>era <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">cut_number</span><span class="op">(</span><span class="va">year</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/uncount.html">uncount</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">avgage</span>, <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_frac</a></span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span> 
  
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">svlenage</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>, <span class="st">"_"</span>,
                                                       <span class="va">s</span>, <span class="st">"agelensamp.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># }</span>
<span class="co"># </span>
<span class="co">#   # read saved sample from above</span>
<span class="co">#   survs &lt;- list.files(path=d.name, pattern = "agelensamp.rds", full.names = TRUE)</span>
<span class="co"># </span>
<span class="co">#   survname &lt;-  str_match(survs, paste0(scenario.name,"_\\s*(.*?)\\s","*agelensamp.rds"))[,2]</span>
<span class="co"># </span>
<span class="co">#   agelensamp_data &lt;- lapply(survs, readRDS)</span>
<span class="co"># </span>
<span class="co">#   names(agelensamp_data) &lt;- survname</span>
<span class="co"># </span>
<span class="co"># </span>
<span class="co"># for(s in names(agelensamp_data)){</span>

  <span class="co"># try different start points to see if we can get more species fit</span>
  <span class="co"># this one goes to 11!</span>
  <span class="co"># need because group_map doesn't keep group names</span>
  <span class="va">gk</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_keys</span><span class="op">(</span><span class="op">)</span>
  
  <span class="va">svvbgf3.2</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                       start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span>,methLinf<span class="op">=</span><span class="st">"longFish"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">#this gets exponential growth pars, probably won't use this growth mod though</span>
  <span class="va">svexp3</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_modify</span><span class="op">(</span><span class="op">~</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">length</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">avgage</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span>, <span class="va">term</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="st">"term"</span>, values_from <span class="op">=</span> <span class="st">"estimate"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>psi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">`(Intercept)`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span><span class="op">(</span>kappa <span class="op">=</span> <span class="va">`log(avgage)`</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span>, <span class="va">kappa</span>, <span class="va">psi</span><span class="op">)</span>
    
  <span class="va">vbout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">gk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
      <span class="va">vbout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vbout.2</span>, <span class="va">spe</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
  
  <span class="va">growthpars</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">svexp3</span>, <span class="va">vbout.2</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>growthType <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">Linf</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span>,
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="co"># vonB default, exponential if no vonB</span>
  
  <span class="co"># sadly doesn't work so just make a csv for each era and use the one with most spp</span>
  <span class="co"># maxera &lt;- growthpars %&gt;% </span>
  <span class="co">#   filter(!is.na(Linf)) %&gt;% </span>
  <span class="co">#   group_by(era) %&gt;% </span>
  <span class="co">#   tally() %&gt;%</span>
  <span class="co">#   filter(n==1) %&gt;%</span>
  <span class="co">#   select(era)</span>
  
  <span class="va">growthspp</span> <span class="op">&lt;-</span> <span class="va">growthpars</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="va">psi</span>, <span class="va">kappa</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">growthType</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_longer</span><span class="op">(</span><span class="va">psi</span><span class="op">:</span><span class="va">growthType</span>, names_to <span class="op">=</span> <span class="st">"par"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">species</span>, 
                values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span> 
  
  <span class="va">growthspp.era</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">growthspp</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">growthspp</span><span class="op">$</span><span class="va">era</span><span class="op">)</span><span class="op">)</span> 
  
  <span class="kw">for</span><span class="op">(</span><span class="va">era</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">growthspp.era</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">gpar</span> <span class="op">&lt;-</span> <span class="va">growthspp.era</span><span class="op">[[</span><span class="va">era</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
      <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span><span class="op">%&gt;%</span>
      <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu">remove_rownames</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
      <span class="fu">column_to_rownames</span><span class="op">(</span>var<span class="op">=</span><span class="st">"par"</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"growth_species_NOBA_era"</span>,<span class="va">era</span>,<span class="st">"_"</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
    
  <span class="op">}</span>
  
<span class="op">}</span></code></pre></div>
<p>This code block has experiments with different fits and different ways to splice the length at age data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="va">capelinvbgf</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Capelin"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">capelinall</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Capelin"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="va">capelinall</span>,pch<span class="op">=</span><span class="fl">19</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">capelinvbgf</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">5</span>,col<span class="op">=</span><span class="st">"red"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">capelinvbgf</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">5</span>,col<span class="op">=</span><span class="st">"blue"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">capelinvbgf</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">5</span>,col<span class="op">=</span><span class="st">"green"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co"># herringvbgf &lt;- svlenage %&gt;%</span>
  <span class="co">#   filter(species == "Norweigan_ssh", era==1) %&gt;%</span>
  <span class="co">#   group_map(try(~nls(length~vb1(avgage, Linf, K, t0), data = .,</span>
  <span class="co">#                 start = vbStarts(length~avgage,data = .))))</span>
     
<span class="co">#Error in nls(length ~ vb1(avgage, Linf, K, t0), data = ., start = vbStarts(length ~  : </span>
  <span class="co">#singular gradient with group_map, era 2 and 3</span>
  <span class="va">codvbgf</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"North_atl_cod"</span><span class="op">)</span> 
    <span class="co">#group_by(era) %&gt;%</span>
    <span class="va">codfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">codvbgf</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">codvbgf</span><span class="op">)</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="va">codvbgf</span>,pch<span class="op">=</span><span class="fl">19</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">codfit</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">20</span>,col<span class="op">=</span><span class="st">"red"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#  era==1   Nonlinear regression model</span>
<span class="co">#   model: length ~ vb1(avgage, Linf, K, t0)</span>
<span class="co">#    data: codvbgf</span>
<span class="co">#     Linf        K       t0 </span>
<span class="co"># 104.7120   0.4260   0.2176 </span>
<span class="co">#  residual sum-of-squares: 4109723</span>
<span class="co"># </span>
<span class="co"># Number of iterations to convergence: 7 </span>
<span class="co"># Achieved convergence tolerance: 2.169e-06</span>
    
<span class="co">#  all years Nonlinear regression model</span>
<span class="co">#   model: length ~ vb1(avgage, Linf, K, t0)</span>
<span class="co">#    data: codvbgf</span>
<span class="co">#     Linf        K       t0 </span>
<span class="co"># 112.4694   0.3912   0.2097 </span>
<span class="co">#  residual sum-of-squares: 7354906</span>
<span class="co"># </span>
<span class="co"># Number of iterations to convergence: 11 </span>
<span class="co"># Achieved convergence tolerance: 9.964e-06</span>
    
  
  <span class="va">hadvbgf</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Haddock"</span><span class="op">)</span> 
    <span class="co">#group_by(era) %&gt;%</span>
  <span class="va">hadfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">hadvbgf</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">hadvbgf</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="va">hadvbgf</span>,pch<span class="op">=</span><span class="fl">19</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">hadfit</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">20</span>,col<span class="op">=</span><span class="st">"red"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>

  
<span class="co"># all years</span>
<span class="co">#     Nonlinear regression model</span>
<span class="co">#   model: length ~ vb1(avgage, Linf, K, t0)</span>
<span class="co">#    data: hadvbgf</span>
<span class="co">#    Linf       K      t0 </span>
<span class="co"># 77.0277  0.3601 -0.3546 </span>
<span class="co">#  residual sum-of-squares: 15637500</span>
<span class="co"># </span>
<span class="co"># Number of iterations to convergence: 11 </span>
<span class="co"># Achieved convergence tolerance: 4.187e-06</span>
    
  <span class="va">redvbgf</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span> <span class="st">"Redfish"</span><span class="op">)</span> 
    <span class="co">#group_by(era) %&gt;%</span>
    
  <span class="va">redfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">redvbgf</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">redvbgf</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="va">redvbgf</span>,pch<span class="op">=</span><span class="fl">19</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">redfit</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">40</span>,col<span class="op">=</span><span class="st">"red"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  
<span class="co">#all years</span>
<span class="co"># Nonlinear regression model</span>
<span class="co">#   model: length ~ vb1(avgage, Linf, K, t0)</span>
<span class="co">#    data: redvbgf</span>
<span class="co">#    Linf       K      t0 </span>
<span class="co"># 40.8016  0.1165 -1.6688 </span>
<span class="co">#  residual sum-of-squares: 3197990</span>
<span class="co"># </span>
<span class="co"># Number of iterations to convergence: 13 </span>
<span class="co"># Achieved convergence tolerance: 8.316e-06 </span>
    
    <span class="va">saithe1</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">species</span><span class="op">==</span><span class="st">"Saithe"</span>,
             <span class="va">era</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span>
    
    <span class="va">saithe1fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">saithe1</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">saithe1</span><span class="op">)</span><span class="op">)</span>
    
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="va">saithe1</span>,pch<span class="op">=</span><span class="fl">19</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html">rgb</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu">vb1</span><span class="op">(</span><span class="va">x</span>,Linf<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">saithe1fit</span><span class="op">)</span><span class="op">)</span>,from<span class="op">=</span><span class="fl">0</span>,to<span class="op">=</span><span class="fl">20</span>,col<span class="op">=</span><span class="st">"red"</span>,lwd<span class="op">=</span><span class="fl">2</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#Nonlinear regression model</span>
<span class="co">#   model: length ~ vb1(avgage, Linf, K, t0)</span>
<span class="co">#    data: saithe1</span>
<span class="co">#      Linf         K        t0 </span>
<span class="co"># 388.18797   0.01975  -3.94798 </span>
<span class="co">#  residual sum-of-squares: 5691213</span>
<span class="co"># </span>
<span class="co"># Number of iterations to convergence: 5 </span>
<span class="co"># Achieved convergence tolerance: 5.511e-06</span>
    
<span class="co">#plot len-age data and start values, some are bad</span>
  <span class="va">svlenage_pl</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data<span class="op">=</span><span class="fu">cur_group</span><span class="op">(</span><span class="op">)</span>,plot<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

  
<span class="co">### full time series fits with different start points  </span>
    
 <span class="va">svvbgf</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 
 <span class="va">spk</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
   <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu">group_keys</span><span class="op">(</span><span class="op">)</span>
 
<span class="va">vballout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">spk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vballout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vballout</span>, <span class="va">sp</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
 
<span class="va">svvbgf.1</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span>,methLinf<span class="op">=</span><span class="st">"oldAge"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 
<span class="va">vballout.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf.1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf.1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">spk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf.1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vballout.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vballout.1</span>, <span class="va">sp</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">svvbgf.2</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span>,methLinf<span class="op">=</span><span class="st">"longFish"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 
<span class="va">vballout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf.2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">spk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vballout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vballout.2</span>, <span class="va">sp</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">################## by era</span>

 <span class="va">gk</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>
   <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu">group_keys</span><span class="op">(</span><span class="op">)</span>

 <span class="va">svvbgf3</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 
<span class="va">vbout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf3</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">gk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf3</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vbout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vbout</span>, <span class="va">spe</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># try different start points to see if we can get more species fit</span>
 <span class="va">svvbgf3.1</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span>,methLinf<span class="op">=</span><span class="st">"oldAge"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="va">vbout.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf3.1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf3.1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">gk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf3.1</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vbout.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vbout.1</span>, <span class="va">spe</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># try different start points to see if we can get more species fit</span>
<span class="co"># this one goes to 11!</span>
<span class="va">svvbgf3.2</span> <span class="op">&lt;-</span> <span class="va">svlenage</span> <span class="op">%&gt;%</span>   
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">era</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_map</span><span class="op">(</span><span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/nls.html">nls</a></span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="fu">vb1</span><span class="op">(</span><span class="va">avgage</span>, <span class="va">Linf</span>, <span class="va">K</span>, <span class="va">t0</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">.</span>,
                  start <span class="op">=</span> <span class="fu">vbStarts</span><span class="op">(</span><span class="va">length</span><span class="op">~</span><span class="va">avgage</span>,data <span class="op">=</span> <span class="va">.</span>,methLinf<span class="op">=</span><span class="st">"longFish"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>


<span class="va">vbout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> 
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">spe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">gk</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">svvbgf3.2</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="va">vbout.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">vbout.2</span>, <span class="va">spe</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Generating length composition input data requires mapping numbers at length in the atlantisom 1 cm bin length output to our selected length bins, then summing the numbers at length in those bins for all species. The input required is a 4d array, indexed by survey, species, year, and sizebin. So each survey can be a separate csv with #species at the top of year rows and sizebin columns with n at length the values, scrolling down for each species.</p>
<p>Arrange lengths into appropriate bins:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># rearrange into length bins and write length comp data csvs</span>
<span class="co"># modbins from sizebins above, differ by species so need modbin.min and modbin.max</span>
<span class="co"># pcumsum is an FSA function</span>

<span class="va">modbins</span> <span class="op">&lt;-</span> <span class="va">sizebins</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>species <span class="op">=</span> <span class="va">`commentField-notused`</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">species</span>, names_to <span class="op">=</span> <span class="st">"sizebin"</span>, values_to <span class="op">=</span> <span class="st">"binwidth"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>modbin.min <span class="op">=</span> <span class="fu">pcumsum</span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span>,
         modbin.max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">species</span>, <span class="va">sizebin</span><span class="op">)</span>


<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">len_comp_data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into long format: year, Species, agecl, length </span>
  <span class="va">svlenbin</span> <span class="op">&lt;-</span> <span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">year</span>, <span class="va">upper.bins</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">modbins</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">modbin.min</span> <span class="op">&lt;</span> <span class="va">upper.bins</span> <span class="op">&amp;</span> <span class="va">upper.bins</span> <span class="op">&lt;=</span> <span class="va">modbin.max</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sumlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">sizebin</span>, <span class="va">sumlen</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_lengths_NOBA_"</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The first pass through with the current bins results in very few lengths in the smallest bin for most species. This suggests we need to change the binwidths and possibly the number of bins to optimize length fitting. Perhaps a larger first bin or don’t start it at 0?</p>
<p><em>Consider a function to do this using species max size, the vonB k and the desired number of bins for more consistency and to easily change Nsizebins.</em></p>
<p>This function is below, but with only 5 bins I don’t like how it works, allocating more smaller bins to the smallest sizes that we don’t observe and aggregating many lengths into one large bin. Therefore the simplest approach is to have equal sized bins (max observed length/desired number of bins). We will try this for the length comps.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># see e.g., https://www.sciencedirect.com/science/article/abs/pii/S0165783619303297</span>
<span class="co"># estimated optimal bin size for VBGF estimation is 0.23 x Lmax ^0.6</span>

<span class="co"># see Ogle citing Schnute and Fornier on K as a growth increment</span>
<span class="co"># https://derekogle.com/NCNRS349/modules/Growth/BKG</span>
<span class="co"># K exponential rate of approach to asymptotic size</span>
<span class="co"># exp(-K) fraction by which growth increment is multiplied each year</span>
<span class="co"># at what length is increment*exp(-K) small? group those lengths into bigger bins</span>

<span class="co"># pull observed min and max size from data to optimize start and end bins</span>
<span class="va">minmaxlen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># read in saved vonB pars--see if seasons are different and will need a replacement if K wasn't estimated</span>
<span class="co">#era &lt;- 1</span>
<span class="va">vonBK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">minmaxvonBK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">len_comp_data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">minmaxlendf</span> <span class="op">&lt;-</span> <span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>minlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">lower.bins</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                     maxlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">upper.bins</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                     range <span class="op">=</span> <span class="va">maxlen</span><span class="op">-</span><span class="va">minlen</span><span class="op">)</span> 
  
  <span class="kw">for</span><span class="op">(</span><span class="va">era</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span>
  <span class="va">vonBKer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"growth_species_NOBA_era"</span>,<span class="va">era</span>,<span class="st">"_"</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span><span class="op">(</span>par <span class="op">=</span> <span class="va">X</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">par</span>, names_to <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">par</span>,
                names_prefix <span class="op">=</span> <span class="va">era</span>,
                values_from <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">species</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">era</span>,<span class="st">"K"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">era</span><span class="op">==</span><span class="fl">1</span>,
         <span class="va">vonBKdf</span> <span class="op">&lt;-</span> <span class="va">vonBKer</span>,
         <span class="va">vonBKdf</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">vonBKdf</span>, <span class="va">vonBKer</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="va">minmaxvonBKdf</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">minmaxlendf</span>,<span class="va">vonBKdf</span><span class="op">)</span>
  
  <span class="va">minmaxlen</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">minmaxlendf</span>
  <span class="va">vonBK</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">vonBKdf</span>
  <span class="va">minmaxvonBK</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">minmaxvonBKdf</span>

<span class="op">}</span>

<span class="co"># note!</span>
<span class="co"># Green_halibut and Saithe have maxlen at 200 in at least one survey, </span>
<span class="co"># may need higher maxlength when running atlantisom comps wrapper, fix survey config files</span>


<span class="va">estbinwidths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Lmax</span>, <span class="va">vonBk</span>, <span class="va">Nsizebins</span>, <span class="va">thresh</span> <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#optimal bin size is lower end</span>
  <span class="va">binopt</span> <span class="op">&lt;-</span> <span class="fl">0.23</span><span class="op">*</span><span class="va">Lmax</span><span class="op">^</span><span class="fl">0.6</span>
  
  <span class="co">#range gives initial default binwidth, all equal (range/Nbins)</span>
  <span class="co">#or should it be max/nbins?</span>
  <span class="co">#can use if no K estimated</span>
  <span class="va">bindef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">Lmax</span><span class="op">/</span><span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">#minmaxvonBK$BTS_fall_allbox_effic1 %&gt;% group_by(species) %&gt;% mutate(bindef = ceiling(maxlen/5))</span>
  
  <span class="co">#vonBk tells you how many fine bins for fast growth</span>
  <span class="co">#low vonBK is doesn't asympote, divide length range equally into nbins?</span>
  <span class="co">#high vonBK asympotes quickly, </span>
  <span class="co"># threshold cumprod of 0.05 or 0.1 to define last bin? tiny growth increment</span>
  <span class="co"># use binopt up to this threshold? </span>
  <span class="co"># plot(cumprod(rep(1, 160)*exp(-0.0386)), ylim=c(0,1), xlim=c(0,180)) #saithe</span>
  <span class="co"># lines(cumprod(rep(1, 20)*exp(-1.4)), ylim=c(0,1), xlim=c(0,180)) #capelin</span>
  <span class="co"># lines(cumprod(rep(1, 40)*exp(-0.163)), ylim=c(0,1), xlim=c(0,180)) #redfish</span>
  <span class="co"># lines(cumprod(rep(1, 130)*exp(-0.344)), ylim=c(0,1), xlim=c(0,180)) #cod</span>
  
  <span class="va">lenthresh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">Lmax</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">vonBk</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">thresh</span><span class="op">)</span><span class="op">)</span> <span class="co">#gives 1 cm increments of fast growth</span>
  
  <span class="co">#put all lengths above this into one big bin, </span>
  <span class="va">binwidth.max</span> <span class="op">&lt;-</span> <span class="va">Lmax</span><span class="op">-</span><span class="va">lenthresh</span>
  
  <span class="co">#divide lengths below this by thresholds? for min 5 bins, use .5, .3, .2, .1, .05?</span>
  <span class="co"># or divide equally into nbins-1 bins? equal may be best</span>
  <span class="co"># hightest growth bin will be very small and we won't have fish in it</span>
  <span class="co"># dont go smaller than binopt</span>
  <span class="va">binwidth.gro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">binopt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">lenthresh</span><span class="op">/</span><span class="op">(</span><span class="va">Nsizebins</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">#aggregate bins in multiples of optimal for bigger fish/slower growth to get Nsizebins</span>
  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">binwidth.max</span> <span class="op">&gt;</span> <span class="va">bindef</span> <span class="op">&amp;</span> <span class="va">binwidth.max</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">Lmax</span>,
         <span class="va">binwidths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">binwidth.gro</span>, <span class="va">Nsizebins</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="va">binwidth.max</span><span class="op">)</span>,
         <span class="va">binwidths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">bindef</span>, <span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">binwidths</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="va">equalbinwidths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Lmax</span>, <span class="va">Nsizebins</span><span class="op">)</span><span class="op">{</span>
  <span class="va">bindef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">Lmax</span><span class="op">/</span><span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span>
  <span class="va">binwidths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">bindef</span>, <span class="va">Nsizebins</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">binwidths</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># for fixed bins across surveys find min and max observed lengths </span>

<span class="va">maxLrange</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">minmaxvonBK</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise</span><span class="op">(</span>minminL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">minlen</span><span class="op">)</span>,
            maxmaxL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">maxlen</span><span class="op">)</span><span class="op">)</span>
  
<span class="va">Nsizebins</span>  <span class="op">&lt;-</span>  <span class="fl">5</span>

<span class="va">newbins</span> <span class="op">&lt;-</span> <span class="va">maxLrange</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_modify</span><span class="op">(</span><span class="op">~</span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="fu">equalbinwidths</span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">maxmaxL</span>, <span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>lb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sizebin"</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nsizebins</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">lb</span>, values_from <span class="op">=</span> <span class="va">x</span><span class="op">)</span>

<span class="va">sizebins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">newbins</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span><span class="st">'commentField-notused'</span> <span class="op">=</span> <span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">relocate</span><span class="op">(</span><span class="st">'commentField-notused'</span>, .after <span class="op">=</span> <span class="fu">last_col</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
                        
<span class="fu">write_csv</span><span class="op">(</span><span class="va">sizebins</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"length_sizebins_NOBA.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Reran the lendat code block above to make the survey-specific length input files with the new equal sized bins.</p>
<p>Now write input files in Gavin’s format to have surveys together in one file. Note that this is just a test. The folder has two different survey and two different fishery configurations; they are not independent. Also, fishery catch is not currently separated into fleets. We wouldn’t use all of these in an input file. Also add fishery length comps:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">modbins</span> <span class="op">&lt;-</span> <span class="va">sizebins</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>species <span class="op">=</span> <span class="va">`commentField-notused`</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">species</span>, names_to <span class="op">=</span> <span class="st">"sizebin"</span>, values_to <span class="op">=</span> <span class="st">"binwidth"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>modbin.min <span class="op">=</span> <span class="fu">pcumsum</span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span>,
         modbin.max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">species</span>, <span class="va">sizebin</span><span class="op">)</span>

<span class="va">allsvlenbin</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>

<span class="co">#multiple surveys named in list object, add to file</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">len_comp_data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into long format: year, Species, agecl, length </span>
  <span class="va">svlenbin</span> <span class="op">&lt;-</span> <span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">year</span>, <span class="va">upper.bins</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">modbins</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">modbin.min</span> <span class="op">&lt;</span> <span class="va">upper.bins</span> <span class="op">&amp;</span> <span class="va">upper.bins</span> <span class="op">&lt;=</span> <span class="va">modbin.max</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sumlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">sizebin</span>, <span class="va">sumlen</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>inpN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">.</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>survey <span class="op">=</span> <span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="fu">contains</span><span class="op">(</span><span class="st">"sizebin"</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span><span class="va">.</span><span class="op">/</span><span class="va">inpN</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">survey</span>, <span class="va">year</span>, <span class="va">species</span>, <span class="va">type</span>, <span class="va">inpN</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">allsvlenbin</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">allsvlenbin</span>, <span class="va">svlenbin</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">allsvlenbin</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_lengths_NOBA_allsurvs.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="co">#requires read_savedfisheries function below, add to atlantisom</span>
<span class="va">catchlen_ss</span> <span class="op">&lt;-</span> <span class="fu">read_savedfisheries</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">"catchLen"</span><span class="op">)</span>

<span class="va">allfishlenbin</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">f</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchlen_ss</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into long format: year, Species, agecl, length </span>
  <span class="va">fishlenbin</span> <span class="op">&lt;-</span> <span class="va">catchlen_ss</span><span class="op">[[</span><span class="va">f</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">year</span>, <span class="va">upper.bins</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">modbins</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">modbin.min</span> <span class="op">&lt;</span> <span class="va">upper.bins</span> <span class="op">&amp;</span> <span class="va">upper.bins</span> <span class="op">&lt;=</span> <span class="va">modbin.max</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sumlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">sizebin</span>, <span class="va">sumlen</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>inpN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">.</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fishery <span class="op">=</span> <span class="va">f</span>,
                  area <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span><span class="op">(</span><span class="fu">vars</span><span class="op">(</span><span class="fu">contains</span><span class="op">(</span><span class="st">"sizebin"</span><span class="op">)</span><span class="op">)</span>, <span class="op">~</span><span class="va">.</span><span class="op">/</span><span class="va">inpN</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fishery</span>, <span class="va">area</span>, <span class="va">year</span>, <span class="va">species</span>, <span class="va">type</span>, <span class="va">inpN</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">fishery</span>, <span class="va">area</span>, <span class="va">species</span>, <span class="va">year</span><span class="op">)</span>
  
  <span class="va">allfishlenbin</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">allfishlenbin</span>, <span class="va">fishlenbin</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">allfishlenbin</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_lengths_NOBA_allfisheries.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Stomach weights are needed as input to hydra. At present each species has a stomach weight for each size bin that is repeated for each year. We have total consumed weight for each predator age class at each timestep in the detailed diet atlantis output, so would need to map age classes to length bins, sum consumed weight by length bin and divide by total numbers in that length bin to get stomach weight.</p>
<p>What we have saved so far is a diet comp in proportion that has had bias and observation error added to proportions. However, we need the stomach weight portion of the equation, which has the survey timing/area/efficiency/selectivity applied to true consumed weight. The hydra input is mean daily stomach weight in grams. From the Atlantis manual, “DetailedDietCheck.txt returns the total consumed biomass since the last output given for each cell (box and layer) of each age group of each functional group.” So daily per capita consumed biomass is this output, summed over prey for total consumption, divided by the numbers from the same survey design, divided by the output step <code>omlist_ss$runpar$outputstep</code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># apply surveys to true total consumption (snipped from atlantosom om_diet.R and om_comps.R)</span>
<span class="va">detaileddiet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>, <span class="st">"detaileddiet.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">usersurvey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span>,
                <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span>,
                <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring_01.R"</span><span class="op">)</span>,
                <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall_01.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">omlist_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>, <span class="st">"omlist_ss.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/omdimensions.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">survObsStomWt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">usersurvey</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="va">s</span>, local <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="co"># survtime doesn't match units of time.days in detaileddiet</span>
  <span class="va">survtime</span> <span class="op">&lt;-</span> <span class="va">survey_sample_full</span><span class="op">*</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstep</span>
  
  <span class="co"># apply survey design to detailed diet</span>
  <span class="va">survey_cons</span> <span class="op">&lt;-</span> <span class="fu">create_survey_diet</span><span class="op">(</span>dat <span class="op">=</span> <span class="va">detaileddiet</span>,
                                    time <span class="op">=</span> <span class="va">survtime</span>,
                                    species <span class="op">=</span> <span class="va">survspp</span>,
                                    boxes <span class="op">=</span> <span class="va">survboxes</span>,
                                    effic <span class="op">=</span> <span class="va">surveffic</span>,
                                    selex <span class="op">=</span> <span class="va">survselex</span><span class="op">)</span>
  
  <span class="co"># get numbers at ageclass for same survey design</span>
  <span class="co"># note different time units!</span>
  <span class="va">survey_N</span> <span class="op">&lt;-</span> <span class="fu">atlantisom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/atlantisom/man/create_survey.html">create_survey</a></span><span class="op">(</span>dat <span class="op">=</span> <span class="va">omlist_ss</span><span class="op">$</span><span class="va">truenums_ss</span>,
                                        time <span class="op">=</span> <span class="va">survey_sample_full</span>,
                                        species <span class="op">=</span> <span class="va">survspp</span>,
                                        boxes <span class="op">=</span> <span class="va">survboxes</span>,
                                        effic <span class="op">=</span> <span class="va">surveffic</span>,
                                        selex <span class="op">=</span> <span class="va">survselex.agecl</span><span class="op">)</span>
  
  <span class="co"># convert survey N times to cons times in days</span>
  <span class="va">survey_N</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">survey_N</span><span class="op">$</span><span class="va">time</span><span class="op">*</span><span class="va">omlist_ss</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstep</span>
  
  <span class="co"># get rid of polygon</span>
  <span class="va">survey_totN</span> <span class="op">&lt;-</span> <span class="va">survey_N</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarise</span><span class="op">(</span>totN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># sum over prey to get total consumption in t, divide by N and timestep, convert to g</span>
  <span class="va">survey_totcons</span> <span class="op">&lt;-</span> <span class="va">survey_cons</span> <span class="op">%&gt;%</span>
    <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">summarise</span><span class="op">(</span>totcons <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">left_join</span><span class="op">(</span><span class="va">survey_totN</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>percap_cons <span class="op">=</span> <span class="va">totcons</span><span class="op">/</span><span class="va">totN</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co">#mutate(daily_percap_g = percap_cons/omlist_ss$runpar$outputstep*1000000)</span>
    <span class="fu">mutate</span><span class="op">(</span>daily_percap_g <span class="op">=</span> <span class="va">percap_cons</span><span class="op">*</span><span class="fl">1000000</span><span class="op">)</span> <span class="co">#try assuming cons is snapshot not cumulative since last timestep</span>

  <span class="co">#save survey consumption, takes a long time to generate with lots of reps/species</span>
  <span class="co">#if(save){</span>
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">survey_cons</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">d.name</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>, <span class="st">"_"</span>,
                                                <span class="va">survey.name</span>, <span class="st">"surveycons.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#}</span>
  
  <span class="va">survObsStomWt</span><span class="op">[[</span><span class="va">survey.name</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">survey_cons</span>
  
<span class="op">}</span>

<span class="co"># map to length bins using surey numbers at agecl in length bins</span>

<span class="co"># #multiple surveys named in list object, use as filename</span>
<span class="co"># for(s in names(all_diets)){</span>
<span class="co">#   #arrange into wide format: year, Species1, Species2 ... and write csv</span>
<span class="co">#   svdiet &lt;- all_diets[[s]][[1]] %&gt;%</span>
<span class="co">#     #calc_timestep2time(d.name, ., run.prm.file) %&gt;% #this gives an arbitrary start year of 1970</span>
<span class="co">#     dplyr::mutate(time = time.days/NOBAom_ms$runpar$toutinc) %&gt;%</span>
<span class="co">#     dplyr::left_join(., trueBagecl) %&gt;%</span>
<span class="co">#     dplyr::mutate(dietBwt = dietSamp*trueBatage) %&gt;%</span>
<span class="co">#     dplyr::group_by(species,time,prey,trueB) %&gt;%</span>
<span class="co">#     dplyr::summarise(totdietBwt = sum(dietBwt)) %&gt;%</span>
<span class="co">#     dplyr::mutate(totdietComp = totdietBwt/trueB) %&gt;%</span>
<span class="co">#     dplyr::mutate(year = ceiling(time/stepperyr)) %&gt;%</span>
<span class="co">#     dplyr::ungroup() %&gt;%</span>
<span class="co">#     dplyr::select(year, species, prey, totdietComp) %&gt;%</span>
<span class="co">#     write_csv(paste0(o.name,"diet_",s,".csv"))</span>
<span class="co"># }</span></code></pre></div>
<p>We also plan to fit to time series of prey proportions for each predator size class. Gavin suggests an input format similar to those for survey lengths. Diet output from surveys is by predator agecl</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># same file as for MSSPM, diet proportion by agecl</span>
<span class="va">all_diets</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survDiet'</span><span class="op">)</span>

<span class="co"># get size bins for predators</span>
<span class="va">sizebins</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"length_sizebins_NOBA.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="va">modbins</span> <span class="op">&lt;-</span> <span class="va">sizebins</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>species <span class="op">=</span> <span class="va">`commentField-notused`</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">!</span><span class="va">species</span>, names_to <span class="op">=</span> <span class="st">"sizebin"</span>, values_to <span class="op">=</span> <span class="st">"binwidth"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>modbin.min <span class="op">=</span> <span class="fu">pcumsum</span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span>,
         modbin.max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">species</span>, <span class="va">sizebin</span><span class="op">)</span>

<span class="co"># get Dirichlet alphamults from config files</span>
<span class="va">svcon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"*survey*"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">svalphamultlook</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svcon</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="va">svcon</span><span class="op">[</span><span class="va">c</span><span class="op">]</span><span class="op">)</span>
  <span class="va">svalp</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>
    surv_alphamult_n <span class="op">=</span> <span class="va">alphamult</span>, 
    survey <span class="op">=</span> <span class="va">survey.name</span>
  <span class="op">)</span>
  <span class="va">svalphamultlook</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">svalphamultlook</span>, <span class="va">svalp</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># diet is by predator agecl, need diet by predator sizebin</span>
<span class="co"># map predator agecl to lengthbin using length_comp_data from same survey</span>

<span class="va">allsvdietprop</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>

<span class="co">#multiple surveys named in list object</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">all_diets</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into lookup for agecl to lengthbin in numbers of fish </span>
  <span class="va">svagelenbin</span> <span class="op">&lt;-</span> <span class="va">len_comp_data</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">year</span>, <span class="va">upper.bins</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">modbins</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">modbin.min</span> <span class="op">&lt;</span> <span class="va">upper.bins</span> <span class="op">&amp;</span> <span class="va">upper.bins</span> <span class="op">&lt;=</span> <span class="va">modbin.max</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">agecl</span>, <span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>sumlen <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">atoutput</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">sizebin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>propage <span class="op">=</span> <span class="va">sumlen</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">sumlen</span><span class="op">)</span><span class="op">)</span> <span class="co">#proportion of each agecl contributing to lengthbin</span>

  <span class="va">svdietprop</span> <span class="op">&lt;-</span> <span class="va">all_diets</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time.days</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="co"># join with agecl to length lookup</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">agecl</span>, <span class="va">year</span>, <span class="va">prey</span>, <span class="va">dietSamp</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">svagelenbin</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dietpropage <span class="op">=</span> <span class="va">dietSamp</span><span class="op">*</span><span class="va">propage</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#reweight diets for lengthbins</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">sizebin</span>, <span class="va">prey</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>dietsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dietpropage</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prey</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">modbins</span><span class="op">$</span><span class="va">species</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#drops predators that don't eat our modeled species</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">prey</span>, <span class="va">dietsize</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">sizebin</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>allotherprey <span class="op">=</span> <span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">.</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>survey <span class="op">=</span> <span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">svalphamultlook</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#what is effective sample size for Dirichlet?</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>inpN <span class="op">=</span> <span class="va">surv_alphamult_n</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#use this input for now</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">survey</span>, <span class="va">year</span>, <span class="va">species</span>, <span class="va">sizebin</span>, <span class="va">inpN</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">allsvdietprop</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">allsvdietprop</span>, <span class="va">svdietprop</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">allsvdietprop</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_diets_NOBA_allsurvs.csv"</span><span class="op">)</span><span class="op">)</span>


<span class="co"># </span></code></pre></div>
<p>Do we need to fit recruitment? May just need average recriutment starting values, which I can get from atlantis. Maturity parameters are needed for SSB calculation and SSB-based recruitment. If we fit only to average recruitment with annual deviations, and don’t need SSB, maturity and recruitment inputs could be dummy parameters for now.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># need 2-par maturity curve based on length, atlantis maturity ogive based on age group</span>
<span class="co"># or just translate age at 50% maturity to length and call it good?</span></code></pre></div>
<p>Survey and catch datasets for hydra from NOBA (same methods as MSSPM). Make this a function that takes output directory name and output names as arguments.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">o.name</span> <span class="op">&lt;-</span> <span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/msinput/hydra/"</span><span class="op">)</span>

<span class="va">stepperyr</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">outputstepunit</span><span class="op">==</span><span class="st">"days"</span><span class="op">)</span> <span class="fl">365</span><span class="op">/</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">runpar</span><span class="op">$</span><span class="va">toutinc</span>

<span class="co">#read in survey biomass data</span>
<span class="va">survObsBiom</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survB'</span><span class="op">)</span> <span class="co">#reads in all surveys</span>

<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">svbio</span> <span class="op">&lt;-</span> <span class="va">survObsBiom</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="co">#calc_timestep2time(d.name, ., run.prm.file) %&gt;% #this gives an arbitrary start year of 1970</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_biomass_NOBA_"</span>,<span class="va">s</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#read in catch data</span>
<span class="va">read_savedfisheries</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span>, <span class="va">type</span><span class="op">)</span><span class="op">{</span>

  <span class="va">datlook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>dattype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Catch'</span>, <span class="st">'catchAge'</span>, <span class="st">'catchLen'</span>, <span class="st">'catchWtage'</span>, <span class="st">'catchAnnAge'</span>, <span class="st">'catchAnnWtage'</span><span class="op">)</span>,
                        pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"*fishCatch.rds"</span>, <span class="st">"*fishObsAgeComp.rds"</span>, <span class="st">"*fishObsLenComp.rds"</span>, <span class="st">"*fishObsWtAtAge.rds"</span>,
                                    <span class="st">"*fishObsFullAgeComp.rds"</span>, <span class="st">"*fishObsFullWtAtAge.rds"</span><span class="op">)</span><span class="op">)</span>

  <span class="va">fisheries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="va">dir</span>, pattern <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">datlook</span><span class="op">$</span><span class="va">pattern</span><span class="op">[</span><span class="va">datlook</span><span class="op">$</span><span class="va">dattype</span> <span class="op">%in%</span> <span class="va">type</span><span class="op">]</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

  <span class="va">fishery.name</span> <span class="op">&lt;-</span>  <span class="fu">str_match</span><span class="op">(</span><span class="va">fisheries</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">scenario.name</span>,<span class="st">"_\\s*(.*?)\\s"</span>,<span class="va">datlook</span><span class="op">$</span><span class="va">pattern</span><span class="op">[</span><span class="va">datlook</span><span class="op">$</span><span class="va">dattype</span><span class="op">==</span><span class="va">type</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>

  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">fisheries</span>, <span class="va">readRDS</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">fishery.name</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">catchbio_ss</span> <span class="op">&lt;-</span> <span class="fu">read_savedfisheries</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'Catch'</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchbio_ss</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">catchbio</span> <span class="op">&lt;-</span> <span class="va">catchbio_ss</span><span class="op">[[</span><span class="va">c</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">time</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_catch_NOBA_"</span>,<span class="va">c</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#write readme for metadata</span>
<span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Simulated data from Norweigan-Barents Atlantis Model by Hansen et al. \n\n"</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Atlantis outputs stored in"</span>, <span class="va">d.name</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Biomass output for surveys"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">)</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Fishery catch output for fisheries"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchbio_ss</span><span class="op">)</span>, <span class="st">'\n\n'</span><span class="op">)</span>,
          <span class="st">"Biomass and catch output units are annual tons.\n\n"</span>,
          <span class="st">"Survey specifications:\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_fall_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/mssurvey_spring_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n\n"</span>,
          <span class="st">"Fishery specifications:\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/msfishery.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>,
          <span class="st">"----------------------\n"</span>,
          <span class="fu">read_file</span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/msfishery_01.R"</span><span class="op">)</span><span class="op">)</span>,
          <span class="st">"\n"</span>
          <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span>, file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/msinput/hydra/"</span><span class="op">)</span>,<span class="st">"README.txt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Survey and catch datasets in Gavin’s suggested format (all surveys together, all fleets together). As above, note that this is just a test. The folder has two different survey and two different fishery configurations; they are not independent. Also, fishery catch is not currently separated into fleets. We wouldn’t use all of these in an input file.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#read in survey biomass data</span>
<span class="va">survObsBiom</span> <span class="op">&lt;-</span> <span class="fu">read_savedsurvs</span><span class="op">(</span><span class="va">d.name</span>, <span class="st">'survB'</span><span class="op">)</span> <span class="co">#reads in all surveys</span>

<span class="co"># get cvs from config files</span>
<span class="va">svcon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"*survey*"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fishcon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/"</span><span class="op">)</span>, pattern <span class="op">=</span> <span class="st">"*fishery*"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">omlist_ss</span> <span class="op">&lt;-</span> <span class="va">NOBAom_ms</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"/simulated-data/config/omdimensions.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">svcvlook</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">svcon</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="va">svcon</span><span class="op">[</span><span class="va">c</span><span class="op">]</span><span class="op">)</span>
  <span class="va">surv_cv_n</span> <span class="op">&lt;-</span> <span class="va">surv_cv</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>survey<span class="op">=</span><span class="va">survey.name</span><span class="op">)</span>
  <span class="va">svcvlook</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">svcvlook</span>, <span class="va">surv_cv_n</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">fcvlook</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">fishcon</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="va">fishcon</span><span class="op">[</span><span class="va">c</span><span class="op">]</span><span class="op">)</span>
  <span class="va">fish_cv_n</span> <span class="op">&lt;-</span> <span class="va">fish_cv</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>fishery<span class="op">=</span><span class="va">fishery.name</span><span class="op">)</span>
  <span class="va">fcvlook</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">fcvlook</span>, <span class="va">fish_cv_n</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">allsvbio</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>

<span class="co">#multiple surveys named in list object, use as filename</span>
<span class="kw">for</span><span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">survObsBiom</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#arrange into wide format: year, Species1, Species2 ... and write csv</span>
  <span class="va">svbio</span> <span class="op">&lt;-</span> <span class="va">survObsBiom</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>biomass <span class="op">=</span> <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>survey <span class="op">=</span> <span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">svcvlook</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">survey</span>, <span class="va">year</span>, <span class="va">species</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">survey</span>, <span class="va">species</span>, <span class="va">year</span><span class="op">)</span>
  
  <span class="va">allsvbio</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">allsvbio</span>, <span class="va">svbio</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">write_csv</span><span class="op">(</span><span class="va">allsvbio</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_biomass_NOBA_allsurvs.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="va">allcatch</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">f</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">catchbio_ss</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">catchbio</span> <span class="op">&lt;-</span> <span class="va">catchbio_ss</span><span class="op">[[</span><span class="va">f</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">time</span><span class="op">/</span><span class="fl">365</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">species</span>, <span class="va">year</span>, <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>catch <span class="op">=</span> <span class="va">atoutput</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>fishery <span class="op">=</span> <span class="va">f</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>area <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">fcvlook</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">fishery</span>, <span class="va">area</span>, <span class="va">year</span>, <span class="va">species</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">fishery</span>, <span class="va">species</span>, <span class="va">year</span><span class="op">)</span>
      
  <span class="va">allcatch</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">allcatch</span>, <span class="va">catchbio</span><span class="op">)</span>  
<span class="op">}</span>

<span class="fu">write_csv</span><span class="op">(</span><span class="va">allcatch</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_catch_NOBA_allfisheries.csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Output temperature data from surveys using “Temp” variable in .nc file and the <code><a href="https://rdrr.io/pkg/atlantisom/man/load_nc_physics.html">atlantisom::load_nc_physics</a></code> function. A survey (timestep, polygons, possibly observation error) can then be applied to this output.</p>
<p>We can get surface and bottom temp from Atlantis using the layers from each polygon, with layer 0 being the bottom and the maximum layer in the polygon being the surface (according to the <a href="https://confluence.csiro.au/display/Atlantis/Atlantis+NetCDF+Structure">Atlantis wiki/Atlantis output files/Atlantis NetCDF structure</a>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># taken from existing load_nc to explore</span>
<span class="co"># file.nc &lt;- file.path(d.name, "outputnordic_runresults_01.nc")</span>
<span class="co"># </span>
<span class="co">#   # Load ATLANTIS output!</span>
<span class="co">#   at_out &lt;- RNetCDF::open.nc(con = file.nc)</span>
<span class="co"># </span>
<span class="co">#   # Get info from netcdf file! (Filestructure and all variable names)</span>
<span class="co">#   var_names_ncdf &lt;- sapply(seq_len(RNetCDF::file.inq.nc(at_out)$nvars - 1),</span>
<span class="co">#     function(x) RNetCDF::var.inq.nc(at_out, x)$name)</span>
<span class="co">#   n_timesteps &lt;- RNetCDF::dim.inq.nc(at_out, 0)$length</span>
<span class="co">#   n_boxes     &lt;- RNetCDF::dim.inq.nc(at_out, 1)$length</span>
<span class="co">#   n_layers    &lt;- RNetCDF::dim.inq.nc(at_out, 2)$length</span>
<span class="co"># </span>
<span class="co"># RNetCDF::close.nc(at_out)</span>

<span class="co">#'@physic_variables A character value spefifying which variables</span>
<span class="co">#'   should be loaded. Only one variable can be loaded at a time.</span>
<span class="co">#'   Currently, only the following variables are allowed:</span>
<span class="co">#'   "salt", "NO3", "NH3", "Temp", "Oxygen", "Si", "Det_Si", "DON",</span>
<span class="co">#'    "Chl_a", "Denitrifiction", "Nitrification".</span>

<span class="va">truetemp</span> <span class="op">&lt;-</span> <span class="fu">atlantisom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/atlantisom/man/load_nc_physics.html">load_nc_physics</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="va">d.name</span>,
                  file_nc <span class="op">=</span> <span class="st">"outputnordic_runresults_01.nc"</span>,
                  physic_variables <span class="op">=</span> <span class="st">"Temp"</span>,
                  aggregate_layers <span class="op">=</span> <span class="cn">FALSE</span>,
                  bboxes <span class="op">=</span> <span class="fu">atlantisom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/atlantisom/man/get_boundary.html">get_boundary</a></span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">boxpars</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#if(verbose) message("Temperature read in.")</span>

<span class="co"># this averages all depth layers, don't want this</span>
<span class="co"># truetempagg &lt;- atlantisom::load_nc_physics(dir = d.name,</span>
<span class="co">#                   file_nc = "outputnordic_runresults_01.nc",</span>
<span class="co">#                   physic_variables = "Temp",</span>
<span class="co">#                   aggregate_layers = TRUE,</span>
<span class="co">#                   bboxes = atlantisom::get_boundary(NOBAom_ms$boxpars))</span>

<span class="va">truebottomtemp</span> <span class="op">&lt;-</span> <span class="va">truetemp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">layer</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># according to Atlantis wiki, layer 0 is bottom</span>

<span class="va">truesurfacetemp</span> <span class="op">&lt;-</span> <span class="va">truetemp</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">layer</span><span class="op">&lt;</span><span class="fl">7</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#layer 7 is always identical temp to layer 0, may be the added sediment layer?</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">polygon</span>, <span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">layer</span><span class="op">==</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">layer</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">ungroup</span>

<span class="va">surveyenv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trueenv</span>, 
                      <span class="va">survboxes</span>,
                      <span class="va">survtimes</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">surveydat</span> <span class="op">&lt;-</span> <span class="va">trueenv</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">polygon</span> <span class="op">%in%</span> <span class="va">survboxes</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">%in%</span> <span class="va">survtimes</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">surveydat</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">omlist_ss</span> <span class="op">&lt;-</span> <span class="va">NOBAom_ms</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/omdimensions.R"</span><span class="op">)</span><span class="op">)</span>

<span class="co">#need to weight by polygon area to get mean annual temp time series for each survey</span>
<span class="va">boxarea</span> <span class="op">&lt;-</span> <span class="fu">map_dfr</span><span class="op">(</span><span class="va">NOBAom_ms</span><span class="op">$</span><span class="va">boxpars</span><span class="op">$</span><span class="va">boxes</span>, <span class="st">"area"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fu">everything</span><span class="op">(</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"polygon"</span>, values_to <span class="op">=</span> <span class="st">"area"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>polygon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">polygon</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>proparea <span class="op">=</span> <span class="va">area</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">area</span><span class="op">)</span><span class="op">)</span>


<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fallcensus_bottomtemp</span> <span class="op">&lt;-</span> <span class="fu">surveyenv</span><span class="op">(</span><span class="va">truebottomtemp</span>, survboxes <span class="op">=</span> <span class="va">survboxes</span>, survtimes <span class="op">=</span> <span class="va">survtime</span><span class="op">)</span>

<span class="va">fallcensus_btempindex</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">fallcensus_bottomtemp</span>, <span class="va">boxarea</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>meantemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">atoutput</span>, <span class="va">proparea</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">meantemp</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_temperature_NOBA_"</span>,<span class="va">survey.name</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">springcensus_bottomtemp</span> <span class="op">&lt;-</span> <span class="fu">surveyenv</span><span class="op">(</span><span class="va">truebottomtemp</span>, survboxes <span class="op">=</span> <span class="va">survboxes</span>, survtimes <span class="op">=</span> <span class="va">survtime</span><span class="op">)</span>

<span class="va">springcensus_btempindex</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">springcensus_bottomtemp</span>, <span class="va">boxarea</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>meantemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">atoutput</span>, <span class="va">proparea</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">meantemp</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_temperature_NOBA_"</span>,<span class="va">survey.name</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_fall_01.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fallnearbox_bottomtemp</span> <span class="op">&lt;-</span> <span class="fu">surveyenv</span><span class="op">(</span><span class="va">truebottomtemp</span>, survboxes <span class="op">=</span> <span class="va">survboxes</span>, survtimes <span class="op">=</span> <span class="va">survtime</span><span class="op">)</span>

<span class="va">fallnearbox_btempindex</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">fallnearbox_bottomtemp</span>, <span class="va">boxarea</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>meantemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">atoutput</span>, <span class="va">proparea</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">meantemp</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_temperature_NOBA_"</span>,<span class="va">survey.name</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="op">(</span><span class="st">"simulated-data/config/mssurvey_spring_01.R"</span><span class="op">)</span><span class="op">)</span>

<span class="va">springnearbox_bottomtemp</span> <span class="op">&lt;-</span> <span class="fu">surveyenv</span><span class="op">(</span><span class="va">truebottomtemp</span>, survboxes <span class="op">=</span> <span class="va">survboxes</span>, survtimes <span class="op">=</span> <span class="va">survtime</span><span class="op">)</span>

<span class="va">springnearbox_btempindex</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">springnearbox_bottomtemp</span>, <span class="va">boxarea</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>meantemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">atoutput</span>, <span class="va">proparea</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">time</span><span class="op">/</span><span class="va">stepperyr</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">meantemp</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">write_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">o.name</span>,<span class="st">"observation_temperature_NOBA_"</span>,<span class="va">survey.name</span>,<span class="st">".csv"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="age-structured-multispecies-statistical-catch-at-age-model-msscaa" class="section level4">
<h4 class="hasAnchor">
<a href="#age-structured-multispecies-statistical-catch-at-age-model-msscaa" class="anchor"></a>Age structured multispecies statistical catch at age model (MSSCAA)</h4>
</div>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Andy Beet, Sean Lucey, Sarah Gaichas, Kiersten Kurti.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
