---
title: "Generating Simulated Data"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(here)
library(tidyverse)  
library(atlantisom)
library(ggthemes)

```

## Simulating input data from an ecosystem model

Here we use existing [Atlantis](https://github.com/Atlantis-Ecosystem-Model/Atlantis_example_and_instructions) ecosystem model output to generate input datasets for a variety of simpler population models, so that the performance of these models can be evaluated against known (simulated) ecosystem dynamics. Atlantis models simulate a wide range of physical and ecological processes, include a full food web, and can be run using different climate forcing, fishing, and other scenarios.  

We extract simulated data using the R package [atlantisom](https://github.com/r4atlantis/atlantisom). The purpose of atlantisom is to use existing Atlantis model output to generate input datasets for a variety of models, so that the performance of these models can be evaluated against known (simulated) ecosystem dynamics. Atlantis models can be run using different climate forcing, fishing, and other scenarios. Users of atlantisom will be able to specify fishery independent and fishery dependent sampling in space and time, as well as species-specific catchability, selectivty, and other observation processes for any Atlantis scenario. Internally consistent multispecies and ecosystem datasets with known observation error characteristics will be the atlantisom outputs, for use in individual model performance testing, comparing performance of alternative models, and performance testing of model ensembles against "true" Atlantis outputs.

## Species in the ms-keyrun dataset

Our initial species selection includes 11 single species groups from the Atlantis NOBA model. 

```{r spp-table}

fgs <- load_fgs(here("simulated-data/atlantisoutput/NOBA_March_2020"), "nordic_groups_v04.csv")

lname <- data.frame(Latin = c("*Hippoglossoides platessoides*",
                              "*Reinhardtius hippoglossoides*",
                              "*Scomber scombrus*",
                              "*Melongrammus aeglefinus*",
                              "*Pollachius virens*",
                              "*Sebastes mentella*",
                              "*Micromesistius poutassou*",
                              "*Clupea harengus*",
                              "*Gadus morhua*",
                              "*Boreogadus saida*",
                              "*Mallotus villosus*"),
                    Code = c("LRD", "GRH", "MAC", "HAD", "SAI", "RED", 
                             "BWH", "SSH", "NCO", "PCO", "CAP")
)

sppsubset <- merge(fgs, lname, all.y = TRUE)
spptable <- sppsubset %>% 
  arrange(Index) %>%
  select(Name, Long.Name, Latin)

knitr::kable(spptable, col.names = c("Model name", "Full name", "Latin name"))

```

Below we will double check survey census outputs against the true values, and then test some survey specifications that may be reasonable for multispecies model testing. Finally we will apply survey functions to the detailed diet data.

## Generating a census dataset (February 2021)

### Configuration files specified once

`NOBA2config.R` specifies location and names of files needed for atlantisom to initialize:

```{r, code = readLines(here("/simulated-data/config/NOBA2Config.R")), eval=F}
```

`omdimensions.R` standardizes timesteps, etc. (this is part of atlantisom and should not need to be changed by the user):

```{r, code = readLines(here("/simulated-data/config/omdimensions.R")), eval=F}
```

### Change these survey and fishery config files

`mssurvey_spring.R` and `mssurvey_fall.R` configure the fishery independent surveys (in this census test, surveys sample all model polygons in all years and have efficiency of 1 for all species, with no size selectivity):

```{r, code = readLines(here("/simulated-data/config/mssurvey_spring.R")), eval=F}
```

```{r, code = readLines(here("/simulated-data/config/mssurvey_fall.R")), eval=F}
```

`msfishery.R` configures the fishery dependent data:

```{r, code = readLines(here("/simulated-data/config/msfishery.R")), eval=F}
```

### Run atlantisom and save outputs

True datasets are generated as follows, using `atlantisom` wrapper functions `om_init` to assemble initial true atlantis data, `om_species` to subset true data for desired species, `om_index` to generate survey biomass and total catch biomass indices, `om_comps` to generate age and length compositions and average weight at age from surveys and fisheries, and `om_diet` to generate diet from surveys. Outputs are saved to the `atlantisoutput` folder (not kept on github due to size):

```{r, eval=FALSE}

NOBAom <- om_init(here("simulated-data/config/NOBA2Config.R"))

NOBAom_ms <- om_species(sppsubset$Name, NOBAom)

#need to change internal call to source in atlantisom om_index om_comps and om_diet functions
#expecting a config folder in same directory as rmd
#this is a workaround

dir.create(file.path(here("docs/config")))

file.copy(here("simulated-data/config/omdimensions.R"), here("docs/config/omdimensions.R"))

NOBAom_ms_ind <- om_index(usersurvey = c(here("simulated-data/config/mssurvey_spring.R"), 
                                         here("simulated-data/config/mssurvey_fall.R")), 
                           userfishery = here("simulated-data/config/msfishery.R"),
                           omlist_ss = NOBAom_ms, 
                           n_reps = 1, 
                           save = TRUE)

NOBAom_ms_comp <- om_comps(usersurvey = c(here("simulated-data/config/mssurvey_spring.R"), 
                                         here("simulated-data/config/mssurvey_fall.R")), 
                           userfishery = here("simulated-data/config/msfishery.R"),
                           omlist_ss = NOBAom_ms, 
                           n_reps = 1, 
                           save = TRUE)

NOBAom_ms_diet <- om_diet(config = here("simulated-data/config", "NOBA2config.R"),
                          dietfile = "NOBADetDiet.gz",
                          usersurvey = c(here("simulated-data/config/mssurvey_spring.R"), 
                                         here("simulated-data/config/mssurvey_fall.R")), 
                          omlist_ss = NOBAom_ms, 
                          n_reps = 1, 
                          save = TRUE)

unlink(here("docs/config"), recursive = TRUE)
```


### Write to model input files

Example input files are in the `model-input-files` directory. First we write the fairly simple biomass and catch inputs for the multispecies surplus production model MSSPM from our census survey outputs. 

```{r write-msspm, eval=FALSE}

o.name <- here("simulated-data/msinput/msspm/")

stepperyr <- if(NOBAom_ms$runpar$outputstepunit=="days") 365/NOBAom_ms$runpar$toutinc

#read in survey biomass data
survObsBiom <- read_savedsurvs(d.name, 'survB') #reads in all surveys

#multiple surveys named in list object, use as filename
for(s in names(survObsBiom)){
  #arrange into wide format: year, Species1, Species2 ... and write csv
  svbio <- survObsBiom[[s]][[1]] %>%
    #calc_timestep2time(d.name, ., run.prm.file) %>% #this gives an arbitrary start year of 1970
    dplyr::mutate(year = ceiling(time/stepperyr)) %>%
    dplyr::select(species, year, atoutput) %>%
    tidyr::spread(species, atoutput) %>%
    write_csv(paste0(o.name,s,".csv"))
}

#read in catch data
read_savedfisheries <- function(dir, type){

  datlook <- data.frame(dattype = c('Catch', 'catchAge', 'catchLen', 'catchWtage', 'catchAnnAge', 'catchAnnWtage'),
                        pattern = c("*fishCatch.rds", "*fishObsAgeComp.rds", "*fishObsLenComp.rds", "*fishObsWtAtAge.rds",
                                    "*fishObsFullAgeComp.rds", "*fishObsFullWtAtAge.rds"))

  fisheries <- list.files(path=dir, pattern = as.character(datlook$pattern[datlook$dattype %in% type]), full.names = TRUE)

  fishery.name <-  str_match(fisheries, paste0(scenario.name,"_\\s*(.*?)\\s",datlook$pattern[datlook$dattype==type]))[,2]

  dat <- lapply(fisheries, readRDS)

  names(dat) <- fishery.name

  return(dat)
}

catchbio_ss <- read_savedfisheries(d.name, 'Catch')

for(c in names(catchbio_ss)){
  #arrange into wide format: year, Species1, Species2 ... and write csv
  catchbio <- catchbio_ss[[c]][[1]] %>%
    dplyr::mutate(year = time/365) %>%
    dplyr::select(species, year, atoutput) %>%
    tidyr::spread(species, atoutput) %>%
    write_csv(paste0(o.name,"fishery_",c,".csv"))
}

#write readme for metadata
meta <- c("Simulated data from Norweigan-Barents Atlantis Model by Hansen et al. \n\n",
          paste("Atlantis outputs stored in", d.name, '\n\n'),
          paste("Biomass output for surveys", names(survObsBiom), '\n\n'),
          paste("Fishery catch output for fisheries", names(catchbio_ss), '\n\n'),
          "Biomass and catch output units are annual tons.\n\n",
          "Survey specifications:\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/mssurvey_fall.R")),
          "\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/mssurvey_spring.R")),
          "\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/mssurvey_fall_01.R")),
          "\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/mssurvey_spring_01.R")),
          "\n\n",
          "Fishery specifications:\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/msfishery.R")),
          "\n",
          "----------------------\n",
          read_file(here("/simulated-data/config/msfishery_01.R")),
          "\n"
          )

cat(as.character(meta), file=paste0(here("simulated-data/msinput/msspm/"),"README.txt"))

```

The MSSPM needs diet compostion information as well. Here we supply two survey time series of diet data, one census and a trial survey dataset with more typical survey coverage issues. 

```{r, write-msspm-diet}

all_diets <- read_savedsurvs(d.name, 'survDiet')

# aggregate over ages (survey diet is in proportion by age)

trueB_age_allbox <- NOBAom_ms$truebio_ss %>%
  #sum over polygons
  aggregate(dat$atoutput,list(dat$species,dat$agecl,dat$time, dat$prey),sum)
  
  

```





## Generating a survey dataset