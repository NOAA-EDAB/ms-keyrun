---
title: "MS Keyrun Species, Environment, Data Formats"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE,
                      warning = FALSE)

library(googledrive)
library(pacman)
p_load(repmis, RCurl, DT, magrittr, gsubfn, stringr, tidyverse)

```

## Species lists

### Multispecies models (focal species)

Multispecies models focus on a subset of interacting species. They will estimate population parameters based on fits to biomass, catch, and (if appropriate) size or age information, establish reference points, and evaluate status for the interacting species.

### Food web model (focal + rest of system)

The food web model is intended to examine wider ecosystem responses to management measures applied to a subset of interacting species. It will estimate predator-prey interaction and other parameters based on fits to biomass, catch, and diet information. This model should track general trends (if not interannual variability) for focal species and produce reasonable reactions by their predators and prey.

Current species groups in the GB Rpath model:
```{r rpathspp, message=FALSE}

# Sean's file from https://github.com/NOAA-EDAB/GBRpath/blob/master/data/SOE_species_list.RData
# loads the RData as object "species"

source_data("https://github.com/NOAA-EDAB/GBRpath/blob/master/data/SOE_species_list.RData?raw=True")

# used to get a list to paste into google form
#write.table(file = "spplist.txt", sort(unique(species$RPATH)))

rpathspp <- species %>%
  select(RPATH, COMNAME, SCINAME, SVSPP) %>%
  filter(RPATH != "") %>%
  distinct() 

aggs <- rpathspp %>%
  count(RPATH, sort = TRUE, name = "Nspp") %>%
  filter(Nspp > 1)

singlespp <- anti_join(rpathspp, aggs) %>%
  mutate(Nspp = 1)

rpathlist <- full_join(singlespp, aggs)
  
datatable(rpathlist, rownames = FALSE, 
          options = list(pageLength = 25, 
                         order = list(list(0, 'asc'))
          ))

```


## Envrionmental data

The `ecodata` R package has up to date information at the Georges Bank EPU scale as listed here: https://noaa-edab.github.io/ecodata/landing_page. 

Current time series in ecodata:
```{r ecodata}

#remotes::install_github("noaa-edab/ecodata",build_vignettes=TRUE)
library(ecodata)

ecodsets <- data(package = "ecodata")$result[, c("Item", "Title")]

datatable(ecodsets, rownames = FALSE, 
          options = list(pageLength = 25)
)

```


## Programming frameworks and data formats

How many models are implemented in R? See [discussion](https://docs.google.com/document/d/19FpJ8w2a-ZZ8ZY4ZmsnjlIilLeN1X9_Tz1dM-KsdOOw/edit#heading=h.kvnvc0pxyvqq) of pros and cons of using R data package for standardizing input datasets and making them available.

## Full survey results

### Survey conducted July 13-24 2020

[This is the survey form.](https://forms.gle/gfA3tKFKRBxf3Mu38)

```{r getsurvey}

#survey link https://forms.gle/gfA3tKFKRBxf3Mu38
#results link https://docs.google.com/spreadsheets/d/1sckY46jdyBa1Fhydw2syBawkjGPcHX4YwQmDCDBXcGU/edit#gid=284425233

resultfile <- drive_find(pattern = "MS-Keyrun Species", type = "spreadsheet")

responses <- drive_download(resultfile, type = "csv", overwrite = TRUE) %>%
  {read.csv(.$local_path)} 

names(responses)[3] <- "Species"
names(responses)[5] <- "Environment"
names(responses)[7] <- "ModelInR"
names(responses)[8] <- "ModelUseR"
names(responses)[9] <- "RData"

```

We had `r nrow(responses)` responses.

### Species

Responses:
```{r, fig.height=6}
# each row is a response with a comma delimited list of species
# string split each row to species
# tally by species
# histogram

msspecies <- data.frame(Species = responses$Species,
                        Model = c("MS", "MS", "NA", "MS", "Rpath", "MS")) %>%
  filter(Model != "NA") %>%
  separate_rows(Species, sep = ",") %>%
  mutate(Species = str_trim(Species, side = "both"))

ggplot(msspecies, aes(Species)) + 
  geom_bar() +
  facet_wrap(~Model, nrow = 2, scales="free") +
  theme(axis.text.x = element_text(angle = 90))

```

```{r} 
knitr::kable(responses$Rationale.for.species.included, col.names = "Species rationale", booktabs=TRUE)
```

### Environment

Responses:
```{r, fig.height=10}
# each row is a response with a comma delimited list of environmental data
# string split each row to dataset name
# tally by dataset
# histogram

msenv <- data.frame(Environment = responses$Environment,
                        Model = c("MS", "MS", "NA", "MS", "Rpath", "MS")) %>%
  filter(Model != "NA") %>%
  separate_rows(Environment, sep = ",") %>%
  mutate(Environment = str_trim(Environment, side = "both"))

ggplot(msenv, aes(Environment)) + 
  geom_bar() +
  facet_wrap(~Model, nrow = 2, scales="free") +
  theme(axis.text.x = element_text(angle = 90))

```

```{r} 
knitr::kable(responses$Rationale.for.environmental.time.series.included, col.names = "Environment rationale", booktabs=TRUE)
```

### Model programming frameworks

Many but not all models interface with R and can use R datasets. Even for those that do not, all agreed on using an R data package for standardizing input datasets and making them available.  

Responses:
```{r}
# these are multiple choice yes/no so just plot

useR <- data.frame(ModelInR = responses$ModelInR,
                   ModelUseR = responses$ModelUseR,
                   RData = responses$RData) %>%
  gather(question, answer, ModelInR:RData) %>%
  mutate(shortans = ifelse(is.na(word(answer, 1, 2)), 
                           answer, 
                           word(answer, 1, 2)))

ggplot(useR, aes(question)) +
  geom_bar(aes(fill=shortans)) +
  labs(x = "Question", 
       fill = "Short Answer") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 35))

```
Short answer key:
"No but" = `r unique(useR$answer)[2]`  
"Probably, we" = `r unique(useR$answer)[4]`

## Meeting minutes, 5 August 2020

[Click here!](https://docs.google.com/document/d/19FpJ8w2a-ZZ8ZY4ZmsnjlIilLeN1X9_Tz1dM-KsdOOw/edit#heading=h.m573izndd2nh)